<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ | –ü–æ—Ä—Ç–∞–ª</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f9; display: flex; }
        
        .sidebar {
            width: 250px;
            background-color: #8b0000;
            color: white;
            min-height: 100vh;
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            position: fixed;
        }
        .user-info {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .user-icon {
            font-size: 50px;
            margin-bottom: 5px;
            line-height: 1;
        }
        .user-info p {
            margin: 0;
            font-size: 14px;
        }
        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            color: white;
            display: block;
        }
        .menu-item:hover {
            background-color: #a52a2a;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            flex-grow: 1;
        }
        .main-content h1 {
            color: #333;
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –†–ï–ó–£–õ–¨–¢–ê–¢–´ --- */
/* --- –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –†–ï–ó–£–õ–¨–¢–ê–¢–´ --- */
.results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
    gap: 25px; 
    margin-top: 20px;
}

.result-card {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    height: 220px; 
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.result-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
}

.card-title {
    font-size: 1.2em;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 10px;
}

.card-rating-label {
    font-size: 0.9em;
    color: #7f8c8d;
    margin-bottom: 5px;
}

.card-grade {
    font-size: 4em;
    font-weight: 900;
    color: #e74c3c; /* –ö—Ä–∞—Å–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    flex-grow: 1; 
    display: flex;
    align-items: center;
    justify-content: center;
}

.card-teacher {
    font-size: 0.85em;
    color: #34495e;
    border-top: 1px solid #ecf0f1;
    padding-top: 10px;
    margin-top: 10px;
}

/* –°–æ–æ–±—â–µ–Ω–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ */
.loading-message, .no-results-message {
    /* –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏—è –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É –≤ Grid-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ */
    width: 100%; 
    text-align: center;
    padding: 20px;
    background-color: #f0f0f0;
    border-radius: 8px;
    color: #34495e;
    font-weight: bold;
    box-sizing: border-box;
}
.action-btn {
    padding: 10px 20px;
    background-color: #3498db; /* –°–∏–Ω—è—è –∫–Ω–æ–ø–∫–∞ */
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}
.action-btn:hover {
    background-color: #2980b9;
}

.grading-tabs {
    display: flex;
    margin-bottom: 15px;
    border-bottom: 2px solid #ddd;
}

.tab-button {
    padding: 10px 15px;
    cursor: pointer;
    background-color: #f4f4f4;
    border: 1px solid #ddd;
    border-bottom: none;
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
    margin-right: 5px;
    font-weight: bold;
    transition: background-color 0.3s;
}

.tab-button.active {
    background-color: #fff;
    border-color: #ddd;
    border-bottom: 2px solid #fff; /* –ü–µ—Ä–µ–∫—Ä—ã–≤–∞–µ–º –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
}

.grading-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.grading-table th, .grading-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
    white-space: nowrap; /* –í–∞–∂–Ω–æ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
}

.grading-table thead th {
    background-color: #f2f2f2;
    font-size: 12px;
}

.table-scroll {
    overflow-x: auto; /* –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ –º–Ω–æ–≥–æ */
}

.grade-input {
    padding: 3px;
    text-align: center;
}

/* CSS –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
.tabs-nav {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 2px solid #ccc;
}
.tab-button {
    background: none;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 16px;
    border-bottom: 2px solid transparent;
    transition: all 0.3s;
}
.tab-button.active {
    border-bottom: 2px solid #8b0000;
    color: #8b0000;
    font-weight: bold;
}
.tab-pane {
    display: none;
    padding-top: 15px;
}
.tab-pane.active {
    display: block;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
.assessment-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}
.assessment-table th, .assessment-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
}
.assessment-table th {
    background-color: #f2f2f2;
    font-weight: bold;
}
.score-value.not-set {
    color: #999;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–≤–æ–¥–∫–∏ */
.summary-box {
    border: 1px solid #8b0000;
    padding: 20px;
    margin-top: 20px;
    background-color: #fff0f0;
    border-radius: 8px;
}
.final-grade-line {
    font-size: 1.2em;
    margin: 10px 0;
}
.final-percent-value {
    color: #000080;
    font-weight: bold;
    margin-left: 10px;
}
.final-letter-value {
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 4px;
    color: white;
}
/* –ü—Ä–∏–º–µ—Ä —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ */
.grade-a { background-color: #27ae60; }
.grade-b { background-color: #2980b9; }
.grade-c { background-color: #f39c12; }
.grade-d { background-color: #d35400; }
.grade-f { background-color: #c0392b; }

    </style>
</head>
<body>
    <div class="sidebar">
        <div class="user-info">
            <div class="user-icon">üë§</div>
            <p id="menuUsername">username</p>
            <p id="menuRole">role</p>
        </div>
        
        <a href="#" class="menu-item" id="profileLink">Profile</a>
        <a href="#" class="menu-item" id="courseLink">Courses</a>
        <a href="#" class="menu-item" id="scheduleLink">Schedule</a>
        <a href="#" class="menu-item" id="resultsLink">Results</a>
        <a href="#" class="menu-item" id="logoutLink">Logout</a>
    </div>

    <div class="main-content">
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –ø–æ—Ä—Ç–∞–ª!</h1>
        <p>–í–∞—à –∫–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å.</p>
        <div id="contentArea"></div>
    </div>
    <div id="messageModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h2 id="modalSubject">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
                    <p class="modal-meta" style="color: #bdc3c7;">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: <span id="modalSender"></span> | –î–∞—Ç–∞: <span id="modalDate"></span></p>
                    <hr>
                    <div id="modalBody" style="white-space: pre-wrap; margin-top: 20px;">
                        ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                    <div class="modal-footer" style="margin-top: 30px; text-align: right;">
                        <button id="deleteMessageBtn" class="action-btn delete-btn" style="background-color: #e74c3c;">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            </div>
    <script>

let USER_ROLE= 'student';

async function loadProfile() {
    try {
        const profileRes = await fetch("/profile");
        
        if (profileRes.status === 401) {
            // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª 401, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
            window.location.href = '/'; 
            return;
        }

        const userData = await profileRes.json();
        
        document.getElementById('menuUsername').textContent = userData.username;
        document.getElementById('menuRole').textContent = userData.role;
        userRole = userData.role;
        document.getElementById('contentArea').textContent = `–í–∞—à–∞ —Ä–æ–ª—å: ${userData.role}`;

    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", error);
        window.location.href = '/'; 
    }
}

 document.getElementById('logoutLink').addEventListener('click', async (e) => {
            e.preventDefault();
            
            await fetch('/logout', { method: 'POST' });
            
            window.location.href = '/'; 
        });

        loadProfile();
async function saveSchedule() {
    // –í—Å—è –ª–æ–≥–∏–∫–∞, –∫–æ—Ç–æ—Ä—É—é –º—ã –ø–∏—Å–∞–ª–∏, –æ—Å—Ç–∞—ë—Ç—Å—è –∑–¥–µ—Å—å. 
    // –û–Ω–∞ –±–µ—Ä–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ DOM, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ contentArea.
    const groupName = document.getElementById('groupSelector').value;
    const dayOfWeek = document.getElementById('daySelector').value;
    const msgBox = document.getElementById('scheduleMessage');
    const tableBody = document.getElementById('scheduleInputTable').querySelector('tbody');
    const rows = tableBody.querySelectorAll('tr');

    const lessons = [];

    rows.forEach(row => {
        const timeSlot = row.getAttribute('data-time');
        const course = row.querySelector('input[data-field="course"]').value.trim();
        const classroom = row.querySelector('input[data-field="classroom"]').value.trim();
        
        if (course || classroom) {
            lessons.push({ time_slot: timeSlot, 
                course: course || '', 
                classroom: classroom || '' });
        }
    });

    if (lessons.length === 0) {
        msgBox.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.';
        msgBox.style.color = 'red';
        return;
    }

    try {
        // ... (–ª–æ–≥–∏–∫–∞ fetch, –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        msgBox.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        msgBox.style.color = 'orange';

        const res = await fetch("/api/save_schedule", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ groupName, dayOfWeek, lessons })
        });

        const data = await res.json();
        
        if (data.success) {
            msgBox.textContent = `‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${groupName} (${dayOfWeek}) —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!`;
            msgBox.style.color = 'green';
        } else {
            msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
            msgBox.style.color = 'red';
        }

    } catch (error) {
        // ...
        console.error("Save schedule error:", error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.';
        msgBox.style.color = 'red';
    }
}

async function loadTeacherSchedule() {
    
    const group = document.getElementById('groupSelector').value;
    const day = document.getElementById('daySelector').value;
    const msgBox = document.getElementById('scheduleMessage');
    
    
    const tableBody = document.getElementById('scheduleInputTable').querySelector('tbody');
    tableBody.querySelectorAll('input').forEach(input => input.value = '');

    if (!group || !day) {
        msgBox.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.';
        msgBox.style.color = 'blue';
        return;
    }
    
    msgBox.textContent = `‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è ${group} (${day})...`;
    msgBox.style.color = 'orange';

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GET-–∑–∞–ø—Ä–æ—Å —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º /api/get_schedule?group=X, –∫–∞–∫ –≤—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ –≤ server.js
        const res = await fetch(`/api/get_schedule?group=${group}&day=${day}`);
        const data = await res.json();
        
        if (data.success && data.schedule && data.schedule.length > 0) {
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ (schedule - —ç—Ç–æ –º–∞—Å—Å–∏–≤ —É—Ä–æ–∫–æ–≤)
            data.schedule.forEach(lesson => {
                const row = tableBody.querySelector(`tr[data-time="${lesson.time_slot}"]`);
                if (row) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–µ–¥–º–µ—Ç –∏ –∞—É–¥–∏—Ç–æ—Ä–∏—é
                    row.querySelector('input[data-field="course"]').value = lesson.course;
                    row.querySelector('input[data-field="classroom"]').value = lesson.classroom;
                    // –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∑–∞–ø–æ–ª–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ, —Ç.–∫. –µ–≥–æ ID –±–µ—Ä–µ—Ç—Å—è –∏–∑ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                }
            });
            
            msgBox.textContent = `‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${group} (${day}) –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.`;
            msgBox.style.color = 'green';
            
        } else {
            msgBox.textContent = `‚ö†Ô∏è –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${group} (${day}) –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ú–æ–∂–Ω–æ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ.`;
            msgBox.style.color = 'orange';
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —É—á–∏—Ç–µ–ª—è:', error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.';
        msgBox.style.color = 'red';
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∫—É—Ä—Å–æ–≤ –¥–ª—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
async function loadAdminCourses() {
    const tableBody = document.getElementById('coursesTableBody');
    const msgBox = document.getElementById('coursesMessage');
    const saveBtn = document.getElementById('saveCourseBtn');
    
    if (saveBtn) {
        saveBtn.removeEventListener('click', saveCourse); 
        saveBtn.addEventListener('click', saveCourse);
    }
    document.getElementById('cancelEditBtn').addEventListener('click', resetCourseForm);

    if (tableBody) tableBody.innerHTML = '';
    if (msgBox) msgBox.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤...';

    try {
        
        const res = await fetch("/api/get_all_courses");
        const data = await res.json();
        
        if (!data.success || !data.courses || data.courses.length === 0) {
            if (msgBox) msgBox.textContent = '–ù–µ—Ç –∫—É—Ä—Å–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.';
            return;
        }

        if (msgBox) msgBox.textContent = '–í—Å–µ–≥–æ –∫—É—Ä—Å–æ–≤: ' + data.courses.length;
        
        data.courses.forEach(course => {
            const row = tableBody.insertRow();
            row.insertCell().textContent = course.id;
            row.insertCell().textContent = course.name;
            row.insertCell().textContent = course.group_name; 
            row.insertCell().textContent = course.semester;  
            row.insertCell().textContent = course.teacher_id;
            row.insertCell().textContent = course.credits;
            
            // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            const actionsCell = row.insertCell();
            
            const editBtn = document.createElement('button');
            editBtn.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å';
            editBtn.onclick = () => editCourse(course);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            deleteBtn.onclick = () => deleteCourse(course.id);
            
            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(deleteBtn);
        });

    } catch (error) {
        console.error("Error loading courses for Admin:", error);
        if (msgBox) msgBox.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏! –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã.';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ JS-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
function attachContentHandlers(role) {
       if (document.getElementById('groupSelector') || document.getElementById('scheduleTableBody')) {
        
        if (role === 'teacher') {
            const saveBtn = document.getElementById('saveScheduleBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveSchedule);
            }
            
            document.getElementById('groupSelector')?.addEventListener('change', loadTeacherSchedule);
            document.getElementById('daySelector')?.addEventListener('change', loadTeacherSchedule);
            
            loadTeacherSchedule(); 

        } else if (role === 'student') {
            loadStudentSchedule();
        }
    }
    initializeAdminFormBinding();
    if (document.getElementById('coursesTableBody')) {
         
        if (role === 'admin') {
            loadAdminCourses(); 
        } else {
            loadCourses(); 

             if (role === 'student') {
                const selector = document.getElementById('semesterSelector');
                    if (selector) {
                    selector.removeEventListener('change', loadCourses);
                    selector.addEventListener('change', loadCourses); 
                }
                }
        }
    }
    if (document.querySelector('.profile-layout')) { 
        if (role === 'student' || role === 'teacher' || role === 'admin') { 
            
            loadProfileData(); 
            attachProfileNavigation(); 
        }
        const form = document.getElementById('changePasswordForm');
        if (form) {
            form.removeEventListener('submit', changePassword);
            form.addEventListener('submit', changePassword); 
        }

        const photoForm = document.getElementById('changePhotoForm');
        const fileInput = document.getElementById('avatarFile');

        if (photoForm && fileInput) {
            photoForm.removeEventListener('submit', uploadAvatar);
            photoForm.addEventListener('submit', uploadAvatar);
            
            fileInput.removeEventListener('change', updateFileNameDisplay);
            fileInput.addEventListener('change', updateFileNameDisplay);
        }
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã
function resetCourseForm() {
    document.getElementById('courseId').value = '';
    document.getElementById('courseName').value = '';
    document.getElementById('courseDescription').value = '';
    document.getElementById('courseCredits').value = '';
    document.getElementById('courseTeacherId').value = '';
    document.getElementById('courseGroup').value = '';
    document.getElementById('courseSemester').value = '';
    document.getElementById('saveCourseBtn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ö—É—Ä—Å';
    document.getElementById('formMessage').textContent = '';
    document.getElementById('cancelEditBtn').style.display = 'none';
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∫—É—Ä—Å–∞
function editCourse(course) {
    document.getElementById('courseId').value = course.id;
    document.getElementById('courseName').value = course.name;
    document.getElementById('courseDescription').value = course.description;
    document.getElementById('courseCredits').value = course.credits;
    document.getElementById('courseTeacherId').value = course.teacher_id;
    document.getElementById('courseGroup').value = course.group_name;
    document.getElementById('courseSemester').value = course.semester;
    
    document.getElementById('saveCourseBtn').textContent = '–û–±–Ω–æ–≤–∏—Ç—å –ö—É—Ä—Å';
    document.getElementById('cancelEditBtn').style.display = 'inline';
    document.getElementById('formMessage').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞: ' + course.name;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
async function saveCourse() {
    const teacherIdElement = document.getElementById('courseTeacherId');
    const msgBox = document.getElementById('formMessage');

    if (!teacherIdElement) {
        if (msgBox) {
            msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞: –§–æ—Ä–º–∞ –∫—É—Ä—Å–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é.';
        }
        
        return;
    }
    
    
    const courseId = document.getElementById('courseId').value || null;
    const name = document.getElementById('courseName').value.trim();
    const group_name = document.getElementById('courseGroup').value.trim(); 
    const semester = parseInt(document.getElementById('courseSemester').value.trim()); 

    const description = document.getElementById('courseDescription').value.trim();
    const credits = parseInt(document.getElementById('courseCredits').value.trim());
    const teacher_id = parseInt(teacherIdElement.value.trim());
    //const msgBox = document.getElementById('formMessage');

    if (!name || isNaN(credits) || isNaN(teacher_id) || !group_name || isNaN(semester)) {
        msgBox.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.';
        return;
    }

    try {
        msgBox.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        const res = await fetch("/api/save_course", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: courseId, name, description, credits, teacher_id, group_name, semester })
        });
        
        const data = await res.json();
        
        if (data.success) {
            msgBox.textContent = `‚úÖ –ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ ${courseId ? '–æ–±–Ω–æ–≤–ª–µ–Ω' : '–¥–æ–±–∞–≤–ª–µ–Ω'}!`;
            resetCourseForm();
            loadAdminCourses();
        } else {
            msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
        }

    } catch (error) {
        console.error("Save course error:", error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.';
    }
}

async function deleteCourse(id) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫—É—Ä—Å?')) return;
    
    const msgBox = document.getElementById('coursesMessage');
    msgBox.textContent = '‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ...';

    try {
        const res = await fetch("/api/delete_course", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id })
        });
        
        const data = await res.json();
        
        if (data.success) {
            msgBox.textContent = `‚úÖ –ö—É—Ä—Å ID ${id} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`;
            loadAdminCourses(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
        } else {
            msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
        }

    } catch (error) {
        console.error("Delete course error:", error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.';
    }
}

async function loadContent(path) {
     let targetFile = '';
    
    // 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–∏ –∏ –ø—É—Ç–∏
    if (path === '/schedule') {
        targetFile = userRole === 'teacher' ? 'teacher_schedule.html' : 'student_schedule.html';
    } else if (path === '/profile') {
        if(userRole === 'admin' ){
            targetFile = 'admin_profile.html';}
        else{
         // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏–ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
        targetFile = userRole === 'teacher' ? 'teacher_profile.html' : 'student_profile.html'; // –°–æ–∑–¥–∞–π—Ç–µ teacher_profile –ø–æ–∑–∂–µ
        }
    }
    
    else if (path === '/courses') {
        if (userRole === 'admin') {
            targetFile = 'admin_courses.html';}
        else{
        targetFile = userRole === 'teacher' ? 'teacher_courses.html' : 'student_courses.html';}
    } 
    else {
        console.error('Unknown path:', path);
        document.getElementById('contentArea').innerHTML = '<p style="color: red;">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é.</p>';
        return;
    }

    // 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ fetch –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–º—É —Ñ–∞–π–ª—É
    try {
        const res = await fetch(targetFile); // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é
        if (!res.ok) throw new Error(`Failed to load ${targetFile} (${res.status})`);
        
        const html = await res.text();
        
        // 3. –í—Å—Ç–∞–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        document.getElementById('contentArea').innerHTML = html; 
        attachContentHandlers(userRole);
        
    } catch (error) {
        console.error('Error loading content:', error);
        document.getElementById('contentArea').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: ' + error.message + '</p>';
    }
}

async function loadProfileData() {
    const contentHeader = document.getElementById('contentHeader');
    const msgBox = document.getElementById('personal-data-section');
    
    if (contentHeader) contentHeader.textContent = '–õ–ò–ß–ù–´–ï –î–ê–ù–ù–´–ï (–ó–∞–≥—Ä—É–∑–∫–∞...)';

    try {
        const res = await fetch("/api/get_profile_data"); // –ù–û–í–´–ô API
        const data = await res.json();
        
        if (data.success && data.user) {
            const user = data.user;
            
            // 1. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            document.getElementById('profileUsername').textContent = user.username || 'N/A';
            
            // 2. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–µ–∫—Ü–∏–∏ "–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
            document.getElementById('displayUsername').textContent = user.username || '‚Äî';
            document.getElementById('displayName').textContent = user.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –ø–æ–ª–µ full_name
            document.getElementById('displayId').textContent = user.id || '‚Äî';
            document.getElementById('displayGroup').textContent = user.group_name || '‚Äî';
            
            // –≠—Ç–∏ –ø–æ–ª—è –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ë–î, –Ω–æ –ø–æ–∫–∞ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–≥–ª—É—à–∫–∏
            document.getElementById('displayMajor').textContent = user.major || '–ù–µ –∑–∞–¥–∞–Ω–æ'; 
            document.getElementById('displayEntranceYear').textContent = user.entrance_year || '–ù–µ –∑–∞–¥–∞–Ω';

            if (contentHeader) contentHeader.textContent = '–õ–ò–ß–ù–´–ï –î–ê–ù–ù–´–ï';
        } else {
            if (msgBox) msgBox.innerHTML = '<p style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
            if (contentHeader) contentHeader.textContent = '–û–®–ò–ë–ö–ê';
        }
    } catch (error) {
        console.error("Profile load error:", error);
        if (msgBox) msgBox.innerHTML = '<p style="color:red;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è.</p>';
        if (contentHeader) contentHeader.textContent = '–û–®–ò–ë–ö–ê –°–ï–¢–ò';
    }
}

document.getElementById('scheduleLink').addEventListener('click', (e) => {
    e.preventDefault();
    loadContent('/schedule');
});

document.getElementById('courseLink').addEventListener('click', (e) => {
    e.preventDefault();
    loadContent('/courses');
});

document.getElementById('profileLink').addEventListener('click', (e) => {
    e.preventDefault();
    loadContent('/profile');
});

async function loadStudentSchedule() {
            const msgBox = document.getElementById('scheduleMessage');
            const tableBody = document.getElementById('scheduleTableBody');
            
            tableBody.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É

            console.log("--- 1. —Ñ—É–Ω–∫—Ü–∏—è loadstudentSchedule –∑–∞–ø—É—â–µ–Ω–∞ ---");

            try {

                console.log("--- 2. –û—Ç–ø—Ä–∞–≤–∫–∞ fetch –∑–∞–ø—Ä–æ—Å–∞... ---");
                // –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –°–µ—Ä–≤–µ—Ä —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≥—Ä—É–ø–ø—É —Å—Ç—É–¥–µ–Ω—Ç–∞.
                const res = await fetch("/api/get_schedule");

                console.log("--- 3. Fetch –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç! ---");
                const data = await res.json();

                console.log("Schedule response:", data);
                
                if (data.success && data.schedule && data.schedule.length > 0) {
                    msgBox.textContent = `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã: ${data.group}`;
                    msgBox.style.color = 'green';
                    document.getElementById('scheduleTitle').textContent = `–í–∞—à–µ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (${data.group})`;
                    
                    let currentDay = '';
                    
                    data.schedule.forEach(lesson => {
                        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
                        if (lesson.day_of_week !== currentDay) {
                            currentDay = lesson.day_of_week;
                            const dayRow = document.createElement('tr');
                            dayRow.innerHTML = `<td colspan="4" class="day-header">${currentDay}</td>`;
                            tableBody.appendChild(dayRow);
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —É—Ä–æ–∫–∞
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${lesson.time_slot}</td>
                            <td style="text-align: left;">${lesson.course}</td>
                            <td>${lesson.classroom}</td>
                            <td>${lesson.teacher_name}</td>
                        `;
                        tableBody.appendChild(row);
                    });

                } else {
                    msgBox.textContent = data.error || `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã ${data.group || '–í–∞—à–µ–π –≥—Ä—É–ø–ø—ã'} –ø–æ–∫–∞ –Ω–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–æ.`;
                    msgBox.style.color = 'red';
                }

            } catch (error) {
                console.error("Schedule load error:", error);
                msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.';
                msgBox.style.color = 'red';
            }
        };

async function loadCourses() {
    const tableBody = document.getElementById('coursesTableBody');
    const msgBox = document.getElementById('coursesMessage');
    
    const role = userRole;

    // –û—á–∏—â–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    if (tableBody) tableBody.innerHTML = ''; 
    if (msgBox) msgBox.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';

    try {
        let apiUrl = "/api/get_courses"

        if(role === 'student') {
            const semesterSelector = document.getElementById('semesterSelector');
            const selectedSemester = semesterSelector ? semesterSelector.value : '1'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1
            
            apiUrl = `/api/get_courses?semester=${selectedSemester}`; 
        }
        const res = await fetch(apiUrl);
        const data = await res.json();
        
        if (!data.success || !data.courses || data.courses.length === 0) {
            if (msgBox) msgBox.textContent = '–°–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω.';
            return;
        }
        

        if (msgBox) msgBox.textContent = ''; //–û—á–∏—Å—Ç–∫–∞

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—É—Ä—Å–æ–≤ –¥–ª—è –°–¢–£–î–ï–ù–¢–ê
       if (data.role === 'student') {
                const tableBody = document.getElementById('coursesTableBody');
                if (tableBody) tableBody.innerHTML = '';
                
                data.courses.forEach(course => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = course.course_name;
                    row.insertCell().textContent = course.teacher_name; 
                    row.insertCell().textContent = course.credits;
                    row.insertCell().textContent = course.description || '‚Äî';
                });
        } else if (data.role === 'teacher') {
            data.courses.forEach(course => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = course.course_name;
                row.insertCell().textContent = course.credits;
                row.insertCell().textContent = course.groups_taught || '–ù–µ—Ç –≥—Ä—É–ø–ø';
            });
        }

    } catch (error) {
        console.error("Error loading courses:", error);
        if (msgBox) msgBox.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏! –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã.';
    }
}

function attachProfileNavigation() {
    const navButtons = document.querySelectorAll('.profile-nav-btn');
    const sections = document.querySelectorAll('.profile-section');
    const contentHeader = document.getElementById('contentHeader');

    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetSectionId = button.getAttribute('data-section');
            const targetHeader = button.textContent;

            // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π
            sections.forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(targetSectionId + '-section').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            if (contentHeader) contentHeader.textContent = targetHeader.toUpperCase();
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è "–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
            if (targetSectionId === 'personal-data') {
                loadProfileData(); 
            }
        });
    });
}

async function changePassword(e) {
    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

    const currentPass = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmNewPassword').value;
    const msgBox = document.getElementById('passwordMessage');
    
    msgBox.textContent = ''; 

    if (newPass.length < 6) {
        msgBox.textContent = '‚ùå –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤.';
        msgBox.style.color = 'red';
        return;
    }
    
    if (newPass !== confirmPass) {
        msgBox.textContent = '‚ùå –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –∏ –µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.';
        msgBox.style.color = 'red';
        return;
    }

    if (currentPass === newPass) {
        msgBox.textContent = '‚ùå –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–∫—É—â–∏–º.';
        msgBox.style.color = 'red';
        return;
    }

    msgBox.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';
    msgBox.style.color = 'orange';

    try {
        const res = await fetch("/api/change_password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                currentPassword: currentPass, 
                newPassword: newPass 
            })
        });

        const data = await res.json();

        if (data.success) {
            msgBox.textContent = '‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!';
            msgBox.style.color = 'green';
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
            document.getElementById('changePasswordForm').reset();
        } else {
            msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.');
            msgBox.style.color = 'red';
        }
    } catch (error) {
        console.error("Change password error:", error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è.';
        msgBox.style.color = 'red';
    }
}

function updateFileNameDisplay() {
    const fileInput = document.getElementById('avatarFile');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    
    if (fileInput.files.length > 0) {
        fileNameDisplay.textContent = fileInput.files[0].name;
    } else {
        fileNameDisplay.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
    }
}    
    

async function uploadAvatar(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('avatarFile');
    const msgBox = document.getElementById('photoMessage');
    
    if (fileInput.files.length === 0) {
        msgBox.textContent = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.';
        msgBox.style.color = 'red';
        return;
    }

    const file = fileInput.files[0];
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –±–æ–ª–µ–µ 5 –ú–ë)
    if (file.size > 5 * 1024 * 1024) {
        msgBox.textContent = '‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5 –ú–ë).';
        msgBox.style.color = 'red';
        return;
    }
    
    msgBox.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...';
    msgBox.style.color = 'orange';

    // FormData –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–≤–æ–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ñ–∞–π–ª–æ–≤)
    const formData = new FormData();
    formData.append('avatar', file);

    try {
        const res = await fetch("/api/upload_avatar", {
            method: "POST",
            // –í–∞–∂–Ω–æ: 'Content-Type' –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è! fetch —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å boundary –¥–ª—è FormData.
            body: formData 
        });

        const data = await res.json();
        
        if (res.status === 200 && data.success) {
            msgBox.textContent = '‚úÖ –ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!';
            msgBox.style.color = 'green';
            
            // ‚ùó –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ç–æ
            const currentAvatar = document.getElementById('currentAvatar');
           // –°–æ–∑–¥–∞–µ–º URL —Å –∫—ç—à-–±–∞—Å—Ç–µ—Ä–æ–º
             const newAvatarUrl = data.filePath + '?t=' + new Date().getTime();
             document.getElementById('currentAvatar').src = newAvatarUrl;

             // ‚ùó –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –≤ –ª–µ–≤–æ–º —Å–∞–π–¥–±–∞—Ä–µ
             // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–∞–π–¥–±–∞—Ä–µ –µ—Å—Ç—å ID 'sidebarAvatar'
            const sidebarAvatar = document.getElementById('sidebarAvatar'); 
            if (sidebarAvatar) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º background-image, –∏—Å–ø–æ–ª—å–∑—É—è URL —Å –∫—ç—à-–±–∞—Å—Ç–µ—Ä–æ–º
                sidebarAvatar.style.backgroundImage = `url('${newAvatarUrl}')`; 
            }
            
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('changePhotoForm').reset();
            document.getElementById('fileNameDisplay').textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';

        } else {
            msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.');
            msgBox.style.color = 'red';
        }
    } catch (error) {
        console.error("Upload error:", error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞.';
        msgBox.style.color = 'red';
    }
}

async function loadProfileAndSetAvatar() {
   try {
        const response = await fetch('/api/get_profile_data');
        const data = await response.json();
    console.log('Response JSON:', data);

        if (data.success) {
            const user = data.user;
            window.userRole = user.role;
            // 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É—Ç–∏ —Å –∫—ç—à-–±–∞—Å—Ç–µ—Ä–æ–º
            const avatarPath = user.avatar_path || '/assets/default_avatar.png';
            const avatarUrl = avatarPath + '?t=' + new Date().getTime(); 

            // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –≤ –±–æ–∫—Å–µ "–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ" (IMG)
            const currentAvatar = document.getElementById('currentAvatar');
            if (currentAvatar) {
                currentAvatar.src = avatarUrl;
            }

            // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –≤ —Å–∞–π–¥–±–∞—Ä–µ (DIV)
            const sidebarAvatar = document.getElementById('sidebarAvatar'); 
            if (sidebarAvatar) {
                // ‚ùó –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º background-image
                sidebarAvatar.style.backgroundImage = `url('${avatarUrl}')`;
            }
            
            // 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (—Ç–µ–ø–µ—Ä—å —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏)
            const profileUsernameElement = document.getElementById('profileUsername');
            if (profileUsernameElement) {
                profileUsernameElement.textContent = user.username;
            }

            const avatarUsernameDisplayElement = document.getElementById('avatarUsernameDisplay');
            if (avatarUsernameDisplayElement) {
                avatarUsernameDisplayElement.textContent = user.username;
            }
            
        } else if (response.status === 401) {
            // –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω
            window.location.href = '/'; 
        } else {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", data.error);
        }
    } catch (error) {
        console.error("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è:", error);
    }
}

document.addEventListener('DOMContentLoaded', loadProfileAndSetAvatar);

async function sendAdminMessage(e) {
    e.preventDefault();
    console.log("Submit event stopped. Sending via Fetch.");

    const subject = document.getElementById('subjectInput').value.trim();
    const message = document.getElementById('messageTextarea').value.trim();
    const resultBox = document.getElementById('adminMessageStatus'); 

    if (!subject || !message) {
        resultBox.textContent = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.';
        resultBox.style.color = 'red';
        return;
    }

    resultBox.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
    resultBox.style.color = 'orange';

    try {
        console.log('Sending admin message', { subject, message });
        const response = await fetch('/api/send_admin_message', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ subject, message })
        });
        console.log('Fetch completed, status =', response.status);

        const data = await response.json();

        if (response.status === 200 && data.success) {
            resultBox.textContent = '‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
            resultBox.style.color = 'green';
            document.getElementById('adminMessageForm').reset();
        } else {
            resultBox.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.'}`;
            resultBox.style.color = 'red';
        }
    } catch (error) {
        resultBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
        resultBox.style.color = 'red';
        console.error("Network error sending admin message:", error);
    }
}

async function loadAdminMessages() {
    const container = document.getElementById('messagesListContainer');
    const status = document.getElementById('messagesStatus');
    
    
    container.innerHTML = '<p style="color: #f39c12; text-align: center;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p>';
    status.textContent = '';

    try {
    
        const response = await fetch('/api/get_admin_messages', { 
            method: 'GET',
            credentials: 'same-origin' 
        });
        
        const data = await response.json();

        if (response.ok && data.success && Array.isArray(data.messages)) {
            if (data.messages.length === 0) {
                container.innerHTML = '<p style="color: #bdc3c7; text-align: center;">–í—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç.</p>';
            } else {
                container.innerHTML = generateMessagesTable(data.messages);
            }
        } else {
            status.textContent = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.'}`;
            container.innerHTML = '';
        }
    } catch (error) {
        status.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.';
        container.innerHTML = '';
        console.error("Error loading admin messages:", error);
    }
}

async function loadAdminContent() {
    const response = await fetch('admin_profile.html');
    const htmlContent = await response.text();
    document.getElementById('mainContentContainer').innerHTML = htmlContent;
}

function generateMessagesTable(messages) {
    let html = '<table class="messages-table"><thead><tr>';
    html += '<th>ID</th><th>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th><th>–¢–µ–º–∞</th><th>–î–∞—Ç–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>';
    html += '</tr></thead><tbody>';

    messages.forEach(msg => {
        const isRead = msg.is_read === 1; 
        const statusText = isRead ? '–ü—Ä–æ—á–∏—Ç–∞–Ω–æ' : '–ù–ï –ü–†–û–ß–ò–¢–ê–ù–û';
        const statusClass = isRead ? 'status-read' : 'status-unread';
        
        html += `
            <tr data-message-id="${msg.id}" class="${statusClass}">
                <td>${msg.id}</td>
                <td>${msg.user_name || '–°—Ç—É–¥–µ–Ω—Ç'}</td>
                <td><a href="#" class="message-subject-link" data-id="${msg.id}">${msg.subject}</a></td>
                <td>${new Date(msg.created_at).toLocaleDateString()}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="action-btn view-btn" data-id="${msg.id}">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                    <button class="action-btn delete-btn" data-id="${msg.id}" style="background-color: #e74c3c;">–£–¥–∞–ª–∏—Ç—å</button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    return html;
}

async function showMessageModal(messageId) {
    const modal = document.getElementById('messageModal');
    const modalBody = document.getElementById('modalBody');
    
    
    modal.style.display = 'block';
    modalBody.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è...';
    
    
    document.getElementById('deleteMessageBtn').setAttribute('data-id', messageId);

    try {
        
        const response = await fetch(`/api/view_message?id=${messageId}`, { 
            method: 'GET',
            credentials: 'same-origin' 
        });
        
        const data = await response.json();

        if (response.ok && data.success && data.message) {
            const msg = data.message;
            
            document.getElementById('modalSubject').textContent = msg.subject;
            document.getElementById('modalSender').textContent = msg.user_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
            document.getElementById('modalDate').textContent = new Date(msg.created_at).toLocaleDateString();
            modalBody.textContent = msg.message;
            
            loadAdminMessages(); 
        } else {
            modalBody.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ${data.error || '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.'}`;
        }
    } catch (error) {
        modalBody.innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.';
        console.error("Error loading single message:", error);
    }
}


function closeModal() {
    const modal = document.getElementById('messageModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

async function deleteMessageHandler(messageId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
        return;
    }

    const deleteBtn = document.getElementById('deleteMessageBtn');
    const originalText = deleteBtn.textContent;
    
    deleteBtn.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';
    deleteBtn.disabled = true;

    try {
        const response = await fetch('/api/delete_message', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: messageId })
        });
        
        const data = await response.json();

        if (response.ok && data.success) {
            alert('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!');
            closeModal();
            loadAdminMessages();
        } else {
            alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.'}`);
        }
    } catch (error) {
        console.error("Error deleting message:", error);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.');
    } finally {
        deleteBtn.textContent = originalText;
        deleteBtn.disabled = false;
    }
}

function handleResultsClick() {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

    if (window.userRole === 'teacher' || window.userRole === 'admin') {
        loadTeacherGradingInterface(); 
    } else if (window.userRole === 'student') {
        loadResultsOverview(); 
    } else {
        contentArea.innerHTML = '<h2 class="page-header">–û–®–ò–ë–ö–ê</h2><p>–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞.</p>';
    }
}

document.addEventListener('DOMContentLoaded', async () => {

    // --- 1. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –∏ —Ä–æ–ª–∏ ---
    try {
        // ‚¨ÖÔ∏è –¢–ï–ü–ï–†–¨ –ú–´ –ñ–î–ï–ú –ó–ê–í–ï–†–®–ï–ù–ò–Ø loadProfileAndSetAvatar
        await loadProfileAndSetAvatar(); 
        
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è/—Ä–æ–ª–∏:", e);
    }
    
    switchProfileSection('personal-data'); // –≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è

    // --- 2. –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –º–µ–Ω—é "Results" ---
    const resultsLink = document.getElementById('resultsLink');
    if (resultsLink) {
        resultsLink.addEventListener('click', (e) => {
            e.preventDefault();
            // –ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ window.userRole –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.—ã
            handleResultsClick(); 
        });
    }

    document.addEventListener('click', function(e) {
        
        const resultCard = e.target.closest('.result-card');
        if (resultCard) {
            const courseId = resultCard.getAttribute('data-course-id');
            const courseName = resultCard.querySelector('.card-title').textContent; 
            e.preventDefault(); 
            
            showCourseDetailsView(courseId, courseName);
        }
        
        if (e.target.id === 'backToOverviewBtn') {
            e.preventDefault();
            loadResultsOverview(); 
        }
    });
});

document.body.addEventListener('click', function(e) {

    if (e.target.matches('.profile-nav-btn')) {
        const sectionId = e.target.getAttribute('data-section');
        e.preventDefault(); 
        console.log(`DELEGATE: –ö–ª–∏–∫ –ø–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: ${sectionId}`);
        switchProfileSection(sectionId);
    } 

    if (e.target.matches('.action-btn.view-btn') || e.target.matches('.message-subject-link')) {
        const messageId = e.target.getAttribute('data-id');
        e.preventDefault(); 
        if (messageId) {
            console.log(`DELEGATE: –í—ã–∑–æ–≤ showMessageModal –¥–ª—è ID: ${messageId}`);
            showMessageModal(messageId);
        }
    }
    
    if (e.target.matches('#deleteMessageBtn')) {
        const messageId = e.target.getAttribute('data-id'); 
        if (messageId) {
             console.log(`DELEGATE: –í—ã–∑–æ–≤ deleteMessageHandler –¥–ª—è ID: ${messageId}`);
            deleteMessageHandler(messageId); 
        }
    }
    
    if (e.target.matches('#messageModal .close-btn') || e.target.id === 'messageModal') {
        closeModal();
    }
});

window.onclick = function(event) {
    const modal = document.getElementById('messageModal');
    if (modal && event.target === modal) {
        closeModal();
    }
}

function initializeAdminFormBinding() {
    const adminForm = document.getElementById('adminMessageForm');

    if (adminForm && !adminForm.dataset.initialized) {
        adminForm.addEventListener('submit', sendAdminMessage);
        adminForm.dataset.initialized = 'true';
        console.log("–ü–æ–∏—Å–∫ —Ñ–æ—Ä–º—ã Admin: –£–°–ü–ï–®–ù–û –ü–†–ò–í–Ø–ó–ê–ù–ê!");
    }
}

function switchProfileSection(sectionId) {
    document.querySelectorAll('.profile-section').forEach(section => {
        section.style.display = 'none';
    });
    document.querySelectorAll('.profile-nav-btn').forEach(button => {
        button.classList.remove('active');
    });

    const targetSection = document.getElementById(sectionId + '-section');
    const targetButton = document.querySelector(`.profile-nav-btn[data-section="${sectionId}"]`);

    if (targetSection) {
        targetSection.style.display = 'block';
    }
    if (targetButton) {
        targetButton.classList.add('active');
    }
    const headerElement = document.getElementById('contentHeader');
    
    if (headerElement) {
        const headerMap = {
            'personal-data': '–õ–ò–ß–ù–´–ï –î–ê–ù–ù–´–ï',
            'change-password': '–°–ú–ï–ù–ê –ü–ê–†–û–õ–Ø',
            'change-photo': '–°–ú–ï–ù–ê –§–û–¢–û',
            'message-to-admin': '–°–û–û–ë–©–ï–ù–ò–ï –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–£',
            'view-messages': '–í–•–û–î–Ø–©–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø'
        };
        headerElement.textContent = headerMap[sectionId] || sectionId.toUpperCase();
    }

    if (sectionId === 'message-to-admin') {
        const messageSection = document.getElementById('message-to-admin-section');
        
        if (messageSection && messageSection.style.display === 'block') {
             initializeAdminFormBinding();
        }
    }
    else if (sectionId === 'view-messages') { 
    const adminMessageSection = document.getElementById('view-messages-section'); 
        
        if (adminMessageSection) {
            console.log("DEBUG: –í—ã–∑–æ–≤ loadAdminMessages –¥–ª—è 'view-messages'"); // –û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–ª–∞–¥–∫—É!
            loadAdminMessages();
        }
    }
}


//–†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ–≤ –∫—É—Ä—Å–∞

function renderResultCard(item) {
    let gradeColor = '#27ae60'; // A
    if (item.letterGrade.startsWith('F')) {
        gradeColor = '#e74c3c'; // F
    } else if (item.letterGrade.startsWith('D') || item.letterGrade.startsWith('C')) {
        gradeColor = '#f39c12'; // D/C
    }
    
    const ratingDisplay = item.currentRating === '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö' 
                          ? `<span style="color:#e74c3c;">${item.currentRating}</span>` 
                          : `–¢–µ–∫—É—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥: ${item.currentRating}`;
                          
    return `
        <div class="result-card" data-course-id="${item.courseId}">
            <div class="card-title">${item.title}</div>
            <div class="card-rating-label">${ratingDisplay}</div>
            
            <div class="card-grade" style="color: ${gradeColor};">${item.letterGrade}</div> 
            
            <div class="card-teacher">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: ${item.teacherName}</div>
        </div>
    `;
}

async function loadResultsOverview() {
    const container = document.getElementById('contentArea');
    
    container.innerHTML = `
        <h2 class="page-header">–û–ë–ó–û–† –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ü–û –ö–£–†–°–ê–ú</h2>
        <div id="results-overview-container" class="results-grid">
            <div class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</div>
        </div>
        <div id="course-details-section" class="details-view" style="display:none;">
            <button id="backToOverviewBtn" class="action-btn">‚Üê –ù–∞–∑–∞–¥ –∫ –æ–±–∑–æ—Ä—É</button>
            <h4 id="detailsTitle" style="margin-top: 20px;">–î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ –ø–æ –∫—É—Ä—Å—É: </h4>
            <div id="details-table-container"></div>
        </div>
    `;
    
    const overviewContainer = document.getElementById('results-overview-container');

    try {
        const response = await fetch('/api/student/results/overview');
        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞.");
        }

        const resultsData = result.data;
        
        if (resultsData.length === 0) {
            overviewContainer.innerHTML = '<div class="no-results-message">–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫—É—Ä—Å–∞–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</div>';
            return;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
        let cardsHtml = '';
        resultsData.forEach(item => {
            cardsHtml += renderResultCard(item);
        });
        
        overviewContainer.innerHTML = cardsHtml;

    } catch (error) {
        console.error("Error loading student results:", error);
        overviewContainer.innerHTML = `<div class="error-message">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: ${error.message}</div>`;
    }
}

async function showCourseDetailsView(courseId, courseName) {
    document.getElementById('results-overview-container').style.display = 'none';
    
    const detailsSection = document.getElementById('course-details-section');
    detailsSection.style.display = 'block';
    
    document.getElementById('detailsTitle').textContent = `–î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ –ø–æ –∫—É—Ä—Å—É: ${courseName}`;
    const container = document.getElementById('details-table-container');
    container.innerHTML = '<p class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</p>';

    try {
        const response = await fetch(`/api/student/results/details/${courseId}`);

        if (!response.ok) {
            const errorText = await response.text();
            console.error("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ JSON (–≤–æ–∑–º–æ–∂–Ω–æ, HTML):", errorText);
            throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –°—Ç–∞—Ç—É—Å: ${response.status}`);
        }

        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞.");
        }

        const groupedData = result.data;
        
        if (Object.keys(groupedData).length === 0) {
            container.innerHTML = '<div class="no-results-message">–®–∞–±–ª–æ–Ω—ã –æ—Ü–µ–Ω–æ–∫ –ø–æ —ç—Ç–æ–º—É –∫—É—Ä—Å—É –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏–ª–∏ –æ—Ü–µ–Ω–∫–∏ –Ω–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω—ã.</div>';
            return;
        }

        //1. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤–∫–ª–∞–¥–æ–∫
        container.innerHTML = `
            <div class="tabs-container">
                <div class="tabs-nav">
                    <button class="tab-button active" data-tab="summary">–û–±—â–∞—è —Å–≤–æ–¥–∫–∞</button>
                    <button class="tab-button" data-tab="weekly">–ù–µ–¥–µ–ª—å–Ω—ã–µ –û—Ü–µ–Ω–∫–∏</button>
                    <button class="tab-button" data-tab="srsp">–°–†–°–ü</button>
                    <button class="tab-button" data-tab="final">–ò—Ç–æ–≥–æ–≤—ã–µ –û—Ü–µ–Ω–∫–∏</button>
                </div>
                <div class="tabs-content">
                    <div id="tab-summary-content" class="tab-pane active"></div>
                    <div id="tab-weekly-content" class="tab-pane"></div>
                    <div id="tab-srsp-content" class="tab-pane"></div>
                    <div id="tab-final-content" class="tab-pane"></div>
                </div>
            </div>
        `;
        
        // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–∞—Å—á–µ—Ç —Å–≤–æ–¥–∫–∏
        const allAssessments = [];
        Object.keys(groupedData).forEach(key => allAssessments.push(...groupedData[key]));
        
        // –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —É–¥–æ–±–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–ù–µ–¥–µ–ª—è -> –ü—Ä–∞–∫—Ç–∏–∫–∞/–õ–µ–∫—Ü–∏—è)
        const weeklyTransformedData = {};
        
        allAssessments.forEach(item => {
            if (item.category === '–ù–µ–¥–µ–ª—å–Ω—ã–µ') {
                const match = item.assessment_name.match(/–ù–µ–¥–µ–ª—è (\d+)/);
                const week = match ? parseInt(match[1]) : 0;
                
                if (week > 0) {
                    if (!weeklyTransformedData[week]) {
                        weeklyTransformedData[week] = {};
                    }
                    if (item.subcategory === '–ü—Ä–∞–∫—Ç–∏–∫–∞') {
                        weeklyTransformedData[week].practice = item;
                    } else if (item.subcategory === '–õ–µ–∫—Ü–∏–∏') {
                        weeklyTransformedData[week].lecture = item;
                    }
                }
            }
        });
        
        // –†–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å–≤–æ–¥–∫–∏ (—Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π —Ä–∞—Å—á–µ—Ç)
        const summary = calculateOverallSummary(allAssessments);

        // --- 3. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ---
        document.getElementById('tab-summary-content').innerHTML = renderSummaryTab(summary);
        document.getElementById('tab-weekly-content').innerHTML = renderWeeklyTable(weeklyTransformedData);
        document.getElementById('tab-srsp-content').innerHTML = renderStudentResultsTable(groupedData['–°–†–°–ü'] || [], '–°–†–°–ü');
        document.getElementById('tab-final-content').innerHTML = renderStudentResultsTable(groupedData['–ò—Ç–æ–≥–æ–≤—ã–µ'] || [], '–ò—Ç–æ–≥–æ–≤—ã–µ –û—Ü–µ–Ω–∫–∏');

        // --- 4. –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–ª–∏–∫–∞ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ ---
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                activateTab(this.dataset.tab);
            });
        });

    } catch (error) {
        console.error("Error loading student assessment details:", error);
        container.innerHTML = `<div class="error-message">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏: ${error.message}</div>`;
    }
}

window.assessmentData = {
    students: [],
    assessments: [],
    grades: {}
};


async function loadTeacherGradingInterface() {
    const container = document.getElementById('contentArea');
    container.innerHTML = `
        <h2 class="page-header">–í–´–°–¢–ê–í–õ–ï–ù–ò–ï –û–¶–ï–ù–û–ö</h2>
        <div class="filter-controls" style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
            <label for="courseSelect">–ö—É—Ä—Å:</label>
            <select id="courseSelect" style="padding: 8px; margin-right: 20px;"></select>
            
            <label for="groupSelect">–ì—Ä—É–ø–ø–∞:</label>
            <select id="groupSelect" style="padding: 8px; margin-right: 20px;" disabled></select>
            
            <button id="loadAssessmentDataBtn" class="action-btn" style="background-color: #3498db;" disabled>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
        </div>
        
        <div id="assessmentDataContainer">
            <p class="loading-message">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –∏ –≥—Ä—É–ø–ø—É –¥–ª—è –Ω–∞—á–∞–ª–∞.</p>
        </div>
    `;

    const courseSelect = document.getElementById('courseSelect');
    const groupSelect = document.getElementById('groupSelect');
    const loadBtn = document.getElementById('loadAssessmentDataBtn');
    const dataContainer = document.getElementById('assessmentDataContainer');
    
    try {
        courseSelect.innerHTML = '<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
        const response = await fetch('/api/teacher/courses');
        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—Å–∞—Ö.");
        }
        
        window.teacherCoursesData = result.data; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ

        courseSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>';
        result.data.forEach(course => {
            const option = document.createElement('option');
            option.value = course.course_id;
            option.textContent = course.course_name;
            option.dataset.groups = JSON.stringify(course.groups);
            courseSelect.appendChild(option);
        });

    } catch (error) {
        console.error("Error loading teacher courses:", error);
        dataContainer.innerHTML = `<p style="color: red;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã: ${error.message}</p>`;
    }
    
    courseSelect.addEventListener('change', () => updateGroupSelect(courseSelect, groupSelect, loadBtn));
    groupSelect.addEventListener('change', () => toggleLoadButton(groupSelect, loadBtn));
    
    loadBtn.addEventListener('click', loadAssessmentTables);
}

/** –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—Å–∞. */
function updateGroupSelect(courseSelect, groupSelect, loadBtn) {
    groupSelect.innerHTML = '';
    groupSelect.disabled = true;
    loadBtn.disabled = true;

    const selectedOption = courseSelect.options[courseSelect.selectedIndex];
    if (selectedOption && selectedOption.value) {
        const groups = JSON.parse(selectedOption.dataset.groups || '[]');
        
        groupSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>';
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group;
            option.textContent = group;
            groupSelect.appendChild(option);
        });
        
        groupSelect.disabled = groups.length === 0;
        if (groups.length === 0) {
             groupSelect.innerHTML = '<option value="">(–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã)</option>';
        }
    }
}

function toggleLoadButton(groupSelect, loadBtn) {
    loadBtn.disabled = !groupSelect.value;
}


/**
 * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –æ—Ü–µ–Ω–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ç —Ç—Ä–∏ —Ç–∞–±–ª–∏—Ü—ã.
 */
async function loadAssessmentTables() {
    const courseId = document.getElementById('courseSelect').value;
    const groupName = document.getElementById('groupSelect').value;
    
    const dataContainer = document.getElementById('assessmentDataContainer');
    dataContainer.innerHTML = `<p class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä—É–ø–ø—ã ${groupName}...</p>`;
    
    try {
        const response = await fetch(`/api/teacher/assessment_data/${courseId}/${encodeURIComponent(groupName)}`);
        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–æ–∫.");
        }
        
        window.assessmentData = result.data;
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∫–ª–∞–¥–æ–∫ –∏ —Ç–∞–±–ª–∏—Ü
        renderGradingInterface(dataContainer, result.data);

    } catch (error) {
        console.error("Error loading assessment data:", error);
        dataContainer.innerHTML = `<p style="color: red;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${error.message}</p>`;
    }
}

/**
 * –£—á–∏—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–æ–∫.
 */
async function showAssessmentTable(courseId, courseName, groupName) {
    document.getElementById('results-overview-container').style.display = 'none';
    
    const detailsSection = document.getElementById('course-details-section');
    detailsSection.style.display = 'block';
    
    document.getElementById('detailsTitle').textContent = `–í—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫: ${courseName} (${groupName})`;
    const container = document.getElementById('details-table-container');
    container.innerHTML = '<p class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞ –æ—Ü–µ–Ω–æ–∫ –∏ —Å–ø–∏—Å–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤...</p>';

    try {
        const response = await fetch(`/api/teacher/assessment_table_data/${courseId}?group=${groupName}`);
        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞.");
        }

        const { students, assessments } = result.data;

        if (assessments.length === 0) {
            container.innerHTML = `<div class="no-results-message">
                –®–∞–±–ª–æ–Ω –æ—Ü–µ–Ω–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –∫—É—Ä—Å–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. 
                <button onclick="createSchema(${courseId}, '${courseName}')" class="btn">–°–æ–∑–¥–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω</button>
            </div>`;
            return;
        }

        // 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ç–∞–±–ª–∏—Ü—ã
        let headerHtml = assessments.map(a => `<th data-assessment-id="${a.id}" class="assessment-header">
            ${a.assessment_name} 
            <span class="weight-info">(${a.weight}%)</span>
        </th>`).join('');

        // 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã (—Å—Ç—É–¥–µ–Ω—Ç—ã)
        let bodyHtml = students.map(student => {
            let rowHtml = assessments.map(a => {
                // –ù–∞—Ö–æ–¥–∏–º –æ—Ü–µ–Ω–∫—É –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –æ—Ü–µ–Ω–∫–∏
                const currentScore = student.scores[a.id] !== undefined ? student.scores[a.id] : '';
                
                return `
                    <td>
                        <input type="number" 
                            class="grade-input" 
                            data-student-id="${student.id}" 
                            data-assessment-id="${a.id}" 
                            value="${currentScore}" 
                            min="0" max="${a.max_score}" 
                            placeholder="${a.max_score}">
                    </td>
                `;
            }).join('');

            return `
                <tr>
                    <td class="student-name" data-student-id="${student.id}">${student.full_name || student.username}</td>
                    ${rowHtml}
                </tr>
            `;
        }).join('');
        
        // 3.–§–∏–Ω–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞
        container.innerHTML = `
            <div class="save-controls">
                <button onclick="saveGrades(${courseId})" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫–∏</button>
                <span id="save-message" class="save-message"></span>
            </div>
            <table class="assessment-grading-table">
                <thead>
                    <tr>
                        <th class="student-name-header">–°—Ç—É–¥–µ–Ω—Ç</th>
                        ${headerHtml}
                    </tr>
                </thead>
                <tbody>
                    ${bodyHtml}
                </tbody>
            </table>
        `;
        
    } catch (error) {
        console.error("Error loading assessment table:", error);
        container.innerHTML = `<div class="error-message">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–æ–∫: ${error.message}</div>`;
    }
}

/**
 * –†–µ–Ω–¥–µ—Ä–∏—Ç –≤–∫–ª–∞–¥–∫–∏ (–ù–µ–¥–µ–ª—å–Ω—ã–µ, –°–†–°–ü, –ò—Ç–æ–≥–æ–≤—ã–µ) –∏ —Ç–∞–±–ª–∏—Ü—ã —Å –ø–æ–ª—è–º–∏ –≤–≤–æ–¥–∞.
 */
function renderGradingInterface(container, data) {
    if (data.students.length === 0) {
        container.innerHTML = `<p class="no-results-message">–í –≥—Ä—É–ø–ø–µ "${document.getElementById('groupSelect').value}" –Ω–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤.</p>`;
        return;
    }
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ç–∏–ø—ã –æ—Ü–µ–Ω–æ–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const groupedAssessments = data.assessments.reduce((acc, item) => {
        if (!acc[item.category]) acc[item.category] = {};
        if (!acc[item.category][item.subcategory]) acc[item.category][item.subcategory] = [];
        acc[item.category][item.subcategory].push(item);
        return acc;
    }, {});
    
    let html = `
        <div class="grading-tabs">
            <button class="tab-button active" data-tab="weekly">–ù–µ–¥–µ–ª—å–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏</button>
            <button class="tab-button" data-tab="srsp">–°–†–°–ü</button>
            <button class="tab-button" data-tab="final">–ò—Ç–æ–≥–æ–≤—ã–µ –æ—Ü–µ–Ω–∫–∏</button>
        </div>
        <form id="gradingForm">
            <div id="tab-weekly" class="tab-content active">
                ${renderWeeklyAssessments(groupedAssessments['–ù–µ–¥–µ–ª—å–Ω—ã–µ'], data)}
            </div>
            <div id="tab-srsp" class="tab-content" style="display:none;">
                ${renderTeacherGradingTable(groupedAssessments['–°–†–°–ü'] ? groupedAssessments['–°–†–°–ü']['–°–†–°–ü'] : [], data)}
            </div>
            <div id="tab-final" class="tab-content" style="display:none;">
                ${renderTeacherGradingTable(groupedAssessments['–ò—Ç–æ–≥–æ–≤—ã–µ'] ? Object.values(groupedAssessments['–ò—Ç–æ–≥–æ–≤—ã–µ']).flat() : [], data)}
            </div>
            
            <div style="margin-top: 25px; text-align: right;">
                <button type="submit" id="saveGradesBtn" class="action-btn" style="background-color: #2ecc71;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫–∏</button>
                <div id="saveMessage" style="margin-top: 10px;"></div>
            </div>
        </form>
    `;
    
    container.innerHTML = html;
    
    // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', (e) => {
            const tabId = e.target.dataset.tab;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            e.target.classList.add('active');
            document.getElementById(`tab-${tabId}`).style.display = 'block';
        });
    });
    
    // –ü—Ä–∏–≤—è–∑–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    document.getElementById('gradingForm').addEventListener('submit', saveGrades);
}

/**
 * –†–µ–Ω–¥–µ—Ä–∏—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ –ü—Ä–∞–∫—Ç–∏–∫—É –∏ –õ–µ–∫—Ü–∏–∏.
 */
function renderWeeklyAssessments(weeklyData, data) {
    if (!weeklyData) return '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –Ω–µ–¥–µ–ª—å–Ω—ã–º –æ—Ü–µ–Ω–∫–∞–º.</p>';
    
    let html = '';
    
    // 1. –°–µ–∫—Ü–∏—è –ü—Ä–∞–∫—Ç–∏–∫–∏
    if (weeklyData['–ü—Ä–∞–∫—Ç–∏–∫–∞']) {
        html += '<h4>–ü—Ä–∞–∫—Ç–∏–∫–∞ (1-15 –ù–µ–¥–µ–ª—è)</h4>';
        html += renderTeacherGradingTable(weeklyData['–ü—Ä–∞–∫—Ç–∏–∫–∞'], data, 'weekly-practice');
    }
    
    // 2. –°–µ–∫—Ü–∏—è –õ–µ–∫—Ü–∏–π
    if (weeklyData['–õ–µ–∫—Ü–∏–∏']) {
        html += '<h4 style="margin-top: 20px;">–õ–µ–∫—Ü–∏–∏ (1-15 –ù–µ–¥–µ–ª—è)</h4>';
        html += renderTeacherGradingTable(weeklyData['–õ–µ–∫—Ü–∏–∏'], data, 'weekly-lectures');
    }
    
    return html;
}

/**
 * –†–µ–Ω–¥–µ—Ä–∏—Ç –æ–±—â—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –æ—Ü–µ–Ω–æ–∫.
 */
function renderTeacherGradingTable(assessments, data, tableId = '') {
    if (assessments.length === 0) return '<p>–ù–µ—Ç —Ç–∏–ø–æ–≤ –æ—Ü–µ–Ω–æ–∫ –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</p>';
    
    let tableHtml = `<div class="table-scroll"><table class="grading-table" id="${tableId}"><thead><tr><th>–°—Ç—É–¥–µ–Ω—Ç</th>`;
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
    assessments.forEach(ass => {
        tableHtml += `<th title="${ass.assessment_name}" data-assessment-id="${ass.id}">${ass.assessment_name.replace('–ù–µ–¥–µ–ª—è ', '–ù').replace('–ü—Ä–∞–∫—Ç–∏–∫–∞, ', '').replace('–õ–µ–∫—Ü–∏—è, ', '')}</th>`;
    });
    
    tableHtml += `</tr></thead><tbody>`;
    
    // –°—Ç—Ä–æ–∫–∏ —Å –ø–æ–ª—è–º–∏ –≤–≤–æ–¥–∞
    data.students.forEach(student => {
        tableHtml += `<tr><td>${student.full_name}</td>`;
        
        assessments.forEach(ass => {
            const assessmentId = ass.id;
            const currentScore = data.grades[student.student_id] 
                                && data.grades[student.student_id][assessmentId] 
                                ? data.grades[student.student_id][assessmentId] 
                                : '';
                                
            tableHtml += `<td><input 
                            type="number" 
                            min="0" 
                            max="100" 
                            value="${currentScore}"
                            data-student-id="${student.student_id}" 
                            data-assessment-id="${assessmentId}"
                            class="grade-input"
                            style="width: 50px; text-align: center;"></td>`;
        });
        
        tableHtml += `</tr>`;
    });
    
    tableHtml += `</tbody></table></div>`;
    
    return tableHtml;
}


/**
 * –°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
 */
async function saveGrades(e) {
    e.preventDefault();
    const saveBtn = document.getElementById('saveGradesBtn');
    const saveMessage = document.getElementById('saveMessage');
    
    saveBtn.disabled = true;
    saveMessage.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    saveMessage.style.color = '#3498db';

    const courseId = document.getElementById('courseSelect').value;
    const gradesToSave = [];
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –Ω–∞ —Ñ–æ—Ä–º–µ
    document.querySelectorAll('.grade-input').forEach(input => {
        const score = parseFloat(input.value);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –æ—Ü–µ–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–≤–µ–¥–µ–Ω—ã –∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¥–æ–ø—É—Å—Ç–∏–º–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
        if (input.value !== '' && !isNaN(score) && score >= 0 && score <= 100) {
            gradesToSave.push({
                student_id: parseInt(input.dataset.studentId),
                assessment_type_id: parseInt(input.dataset.assessmentId),
                course_id: parseInt(courseId),
                score: score
            });
        }
    });

    try {
        const response = await fetch('/api/teacher/save_assessments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(gradesToSave)
        });
        
        const result = await response.json();

        if (response.ok && result.success) {
            saveMessage.textContent = `–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${gradesToSave.length} –æ—Ü–µ–Ω–æ–∫.`;
            saveMessage.style.color = '#27ae60';
        } else {
            throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.');
        }

    } catch (error) {
        console.error("Save error:", error);
        saveMessage.textContent = `–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`;
        saveMessage.style.color = '#e74c3c';
    } finally {
        saveBtn.disabled = false;
    }
}

//–ü–æ–¥—Ä–æ–±–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ü–µ–Ω–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–∞–º

function activateTab(tabId) {
    // –°–Ω–∏–º–∞–µ–º –∫–ª–∞—Å—Å 'active' —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –ø–∞–Ω–µ–ª–µ–π
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å 'active' –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É –∏ –ø–∞–Ω–µ–ª—å
    const activeBtn = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
    const activePane = document.getElementById(`tab-${tabId}-content`);
    if (activePane) {
        activePane.classList.add('active');
    }
}

function calculateOverallSummary(assessments) {
    let totalEarnedWeight = 0; 
    let maxWeight = 0;         

    assessments.forEach(item => {
        const weight = parseFloat(item.weight) || 0;
        const maxScore = parseFloat(item.max_score) || 1; 

        if (weight > 0) {
            maxWeight += weight;
            
            // –ï—Å–ª–∏ –±–∞–ª–ª –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω (–Ω–µ NULL), —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–∫–ª–∞–¥ –≤ –∏—Ç–æ–≥–æ–≤—É—é –æ—Ü–µ–Ω–∫—É
            if (item.score !== null) {
                const score = parseFloat(item.score) || 0;
                
                // –†–∞—Å—á–µ—Ç: (–ü–æ–ª—É—á–µ–Ω–Ω—ã–π –±–∞–ª–ª / –ú–∞–∫—Å. –±–∞–ª–ª) * –í–µ—Å
                const earnedPoints = (score / maxScore) * weight;
                totalEarnedWeight += earnedPoints;
            }
        }
    });

    const finalPercent = totalEarnedWeight > 0 ? (totalEarnedWeight / maxWeight) * 100 : 0;

    const getLetterGrade = (percent) => {
        if (percent >= 90) return 'A';
        if (percent >= 80) return 'B';
        if (percent >= 70) return 'C';
        if (percent >= 60) return 'D';
        return 'F';
    };

    return {
        totalEarnedWeight: totalEarnedWeight.toFixed(2),
        maxWeight: maxWeight.toFixed(2),
        finalPercent: finalPercent.toFixed(2),
        letterGrade: getLetterGrade(finalPercent)
    };
}

function renderWeeklyTable(data) {
    if (Object.keys(data).length === 0) {
        return '<p class="no-results-message">–ù–µ–¥–µ–ª—å–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω—ã.</p>';
    }

    let html = `
        <h3 class="assessment-category-title">–ù–µ–¥–µ–ª—å–Ω—ã–µ –û—Ü–µ–Ω–∫–∏ (–í–µ—Å: 1% –∫–∞–∂–¥–∞—è)</h3>
        <table class="assessment-table weekly-table">
            <thead>
                <tr>
                    <th>–ù–µ–¥–µ–ª—è</th>
                    <th>–ü—Ä–∞–∫—Ç–∏–∫–∞</th>
                    <th>–õ–µ–∫—Ü–∏–∏</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    // –†–∏—Å—É–µ–º –¥–æ 15 –Ω–µ–¥–µ–ª—å
    for (let i = 1; i <= 15; i++) {
        const weekData = data[i] || {};
        const p = weekData.practice;
        const l = weekData.lecture;

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —è—á–µ–π–∫–∏: "–ë–∞–ª–ª / –ú–∞–∫—Å. –±–∞–ª–ª"
        const formatScore = (item) => {
            if (!item) return '‚Äî';
            // –ï—Å–ª–∏ score === null, –∑–Ω–∞—á–∏—Ç –æ—Ü–µ–Ω–∫–∞ –Ω–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–∞
            return item.score !== null 
                ? `<span class="score-value">${item.score}</span> / ${item.max_score}`
                : `<span class="score-value not-set">‚Äî</span> / ${item.max_score}`;
        };

        html += `
            <tr>
                <td>–ù–µ–¥–µ–ª—è ${i}</td>
                <td>${formatScore(p)}</td>
                <td>${formatScore(l)}</td>
            </tr>
        `;
    }

    html += `
            </tbody>
        </table>
    `;

    return html;
}

function renderStudentResultsTable(assessments, title) {
    if (assessments.length === 0) {
        return `<p class="no-results-message">–û—Ü–µ–Ω–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${title}" –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω—ã.</p>`;
    }

    let html = `
        <h3 class="assessment-category-title">${title}</h3>
        <table class="assessment-table">
            <thead>
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–í–µ—Å (%)</th>
                    <th>–ú–∞–∫—Å. –ë–∞–ª–ª</th>
                    <th>–ü–æ–ª—É—á–µ–Ω–Ω—ã–π –ë–∞–ª–ª</th>
                </tr>
            </thead>
            <tbody>
    `;

    assessments.forEach(item => {
        const weightValue = parseFloat(item.weight) || 0;
        const maxScoreValue = parseFloat(item.max_score) || 100;

        const scoreDisplay = item.score !== null 
            ? `<span class="score-value">${parseFloat(item.score)}</span>` 
            : `<span class="score-value not-set">‚Äî</span>`;

        html += `
            <tr>
                <td>${item.assessment_name}</td>
                <td>${weightValue.toFixed(2)}%</td>  <td>${maxScoreValue}</td>
                <td>${scoreDisplay}</td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
    `;

    return html;
}

function renderSummaryTab(summary) {
    return `
        <h2 class="page-header">–û–±—â–∏–π –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ –ö—É—Ä—Å—É</h2>
        <div class="summary-box">
            <p><strong>–û–±—â–∏–π –í–µ—Å –ö—É—Ä—Å–∞:</strong> ${summary.maxWeight}%</p>
            <p><strong>–ù–∞–±—Ä–∞–Ω–Ω—ã–π –í–µ—Å (–¢–µ–∫—É—â–∏–π):</strong> ${summary.totalEarnedWeight}%</p>
            <hr>
            <p class="final-grade-line">
                <strong>–ò–¢–û–ì–û–í–´–ô –ü–†–û–¶–ï–ù–¢:</strong> 
                <span class="final-percent-value">${summary.finalPercent}%</span>
            </p>
            <p class="final-grade-line">
                <strong>–ë–£–ö–í–ï–ù–ù–ê–Ø –û–¶–ï–ù–ö–ê:</strong> 
                <span class="final-letter-value grade-${summary.letterGrade.toLowerCase()}">${summary.letterGrade}</span>
            </p>
        </div>
        <p class="summary-note">
            * –ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫ –∏ –∏—Ö –≤–µ—Å–æ–≤.
        </p>
    `;
}
    </script>
</body>
</html>