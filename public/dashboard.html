<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ | –ü–æ—Ä—Ç–∞–ª</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f9; display: flex; }
        
        .sidebar {
            width: 250px;
            background-color: #8b0000;
            color: white;
            min-height: 100vh;
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            position: fixed;
        }
        .user-info {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .user-icon {
            font-size: 50px;
            margin-bottom: 5px;
            line-height: 1;
        }
        .user-info p {
            margin: 0;
            font-size: 14px;
        }
        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            color: white;
            display: block;
        }
        .menu-item:hover {
            background-color: #a52a2a;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            flex-grow: 1;
        }
        .main-content h1 {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="user-info">
            <div class="user-icon">üë§</div>
            <p id="menuUsername">username</p>
            <p id="menuRole">role</p>
        </div>
        
        <a href="#" class="menu-item" id="profileLink">Profile</a>
        <a href="#" class="menu-item">Courses</a>
        <a href="#" class="menu-item" id="scheduleLink">Schedule</a>
        <a href="#" class="menu-item">Results</a>
        <a href="#" class="menu-item" id="logoutLink">Logout</a>
    </div>

    <div class="main-content">
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –ø–æ—Ä—Ç–∞–ª!</h1>
        <p>–í–∞—à –∫–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å.</p>
        <div id="contentArea"></div>
    </div>

    <script>
 async function loadContent(url) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä!
        const contentArea = document.getElementById('contentArea');
        contentArea.innerHTML = '<h1>–ó–∞–≥—Ä—É–∑–∫–∞...</h1>';
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π (–µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏)
        contentArea.onclick = null; 
        
        try {
            const res = await fetch(url);
            if (res.status === 200) {
                const html = await res.text();
                
                contentArea.innerHTML = html;
                
            } else {
                contentArea.innerHTML = `<h1>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (${res.status})!</h1>`;
            }
        } catch (error) {
            contentArea.innerHTML = '<h1>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏! –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç.</h1>';
            console.error('Content load error:', error);
        }
    }

   document.getElementById('scheduleLink').addEventListener('click', (e) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–∂–∞—Ç–∞ –∏–º–µ–Ω–Ω–æ "Schedule" (—Ö–æ—Ç—è ID —É–∂–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —ç—Ç–æ)
    if (e.target.textContent === 'Schedule') { 
        e.preventDefault();
        
        // –ß–∏—Ç–∞–µ–º —Ä–æ–ª—å –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞, –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ loadProfile
        const currentRole = document.getElementById('menuRole').textContent;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        let urlToLoad = '';
        if (currentRole === 'teacher') {
            urlToLoad = '/teacher_schedule.html';
        } else if (currentRole === 'student') {
            urlToLoad = '/student_schedule.html'; // –ë—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –¥–∞–ª–µ–µ
        } else {
            document.getElementById('contentArea').innerHTML = '<h1>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.</h1>';
            return;
        }
        
        loadContent(urlToLoad);
    }
});

async function loadProfile() {
    try {
        const profileRes = await fetch("/profile");
        
        if (profileRes.status === 401) {
            // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª 401, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
            window.location.href = '/'; 
            return;
        }

        const userData = await profileRes.json();
        
        document.getElementById('menuUsername').textContent = userData.username;
        document.getElementById('menuRole').textContent = userData.role;

        document.getElementById('contentArea').textContent = `–í–∞—à–∞ —Ä–æ–ª—å: ${userData.role}`;

    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", error);
        window.location.href = '/'; 
    }
}

 document.getElementById('logoutLink').addEventListener('click', async (e) => {
            e.preventDefault();
            
            await fetch('/logout', { method: 'POST' });
            
            window.location.href = '/'; 
        });

        loadProfile();
async function saveSchedule() {
    // –í—Å—è –ª–æ–≥–∏–∫–∞, –∫–æ—Ç–æ—Ä—É—é –º—ã –ø–∏—Å–∞–ª–∏, –æ—Å—Ç–∞—ë—Ç—Å—è –∑–¥–µ—Å—å. 
    // –û–Ω–∞ –±–µ—Ä–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ DOM, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ contentArea.
    const groupName = document.getElementById('groupSelector').value;
    const dayOfWeek = document.getElementById('daySelector').value;
    const msgBox = document.getElementById('scheduleMessage');
    const tableBody = document.getElementById('scheduleInputTable').querySelector('tbody');
    const rows = tableBody.querySelectorAll('tr');

    const lessons = [];

    rows.forEach(row => {
        const timeSlot = row.getAttribute('data-time');
        const course = row.querySelector('input[data-field="course"]').value.trim();
        const classroom = row.querySelector('input[data-field="classroom"]').value.trim();
        
        if (course || classroom) {
            lessons.push({ time_slot: timeSlot, 
                course: course || '', 
                classroom: classroom || '' });
        }
    });

    if (lessons.length === 0) {
        msgBox.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.';
        msgBox.style.color = 'red';
        return;
    }

    try {
        // ... (–ª–æ–≥–∏–∫–∞ fetch, –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        msgBox.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        msgBox.style.color = 'orange';

        const res = await fetch("/api/save_schedule", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ groupName, dayOfWeek, lessons })
        });

        const data = await res.json();
        
        if (data.success) {
            msgBox.textContent = `‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${groupName} (${dayOfWeek}) —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!`;
            msgBox.style.color = 'green';
        } else {
            msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
            msgBox.style.color = 'red';
        }

    } catch (error) {
        // ...
        console.error("Save schedule error:", error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.';
        msgBox.style.color = 'red';
    }
}

async function loadTeacherSchedule() {
    // –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const group = document.getElementById('groupSelector').value;
    const day = document.getElementById('daySelector').value;
    const msgBox = document.getElementById('scheduleMessage');
    
    // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π (—á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)
    const tableBody = document.getElementById('scheduleInputTable').querySelector('tbody');
    tableBody.querySelectorAll('input').forEach(input => input.value = '');

    if (!group || !day) {
        msgBox.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.';
        msgBox.style.color = 'blue';
        return;
    }
    
    msgBox.textContent = `‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è ${group} (${day})...`;
    msgBox.style.color = 'orange';

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GET-–∑–∞–ø—Ä–æ—Å —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º /api/get_schedule?group=X, –∫–∞–∫ –≤—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ –≤ server.js
        const res = await fetch(`/api/get_schedule?group=${group}&day=${day}`);
        const data = await res.json();
        
        if (data.success && data.schedule && data.schedule.length > 0) {
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ (schedule - —ç—Ç–æ –º–∞—Å—Å–∏–≤ —É—Ä–æ–∫–æ–≤)
            data.schedule.forEach(lesson => {
                const row = tableBody.querySelector(`tr[data-time="${lesson.time_slot}"]`);
                if (row) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–µ–¥–º–µ—Ç –∏ –∞—É–¥–∏—Ç–æ—Ä–∏—é
                    row.querySelector('input[data-field="course"]').value = lesson.course;
                    row.querySelector('input[data-field="classroom"]').value = lesson.classroom;
                    // –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∑–∞–ø–æ–ª–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ, —Ç.–∫. –µ–≥–æ ID –±–µ—Ä–µ—Ç—Å—è –∏–∑ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                }
            });
            
            msgBox.textContent = `‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${group} (${day}) –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.`;
            msgBox.style.color = 'green';
            
        } else {
            msgBox.textContent = `‚ö†Ô∏è –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${group} (${day}) –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ú–æ–∂–Ω–æ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ.`;
            msgBox.style.color = 'orange';
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —É—á–∏—Ç–µ–ª—è:', error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.';
        msgBox.style.color = 'red';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ JS-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
function attachScheduleHandlers(role) {
     if (role === 'teacher') {
        const saveBtn = document.getElementById('saveScheduleBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', saveSchedule);
        }
        
        // –í–ê–ñ–ù–û: –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º—É —É—á–∏—Ç–µ–ª—è
        document.getElementById('groupSelector')?.addEventListener('change', loadTeacherSchedule);
        document.getElementById('daySelector')?.addEventListener('change', loadTeacherSchedule);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É—á–∏—Ç–µ–ª—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏:
        loadTeacherSchedule(); 

    } else if (role === 'student') {
        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞
        loadStudentSchedule();
    }
}


// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è loadContent
async function loadContent(url, role) {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = '<h1>–ó–∞–≥—Ä—É–∑–∫–∞...</h1>';
    
    try {
        const res = await fetch(url);
        if (res.status === 200) {
            const html = await res.text();
            
            // –ü—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–ª—è–µ–º HTML-–∫–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–ø–µ—Ä—å –æ–Ω –±–µ–∑ —Å–∫—Ä–∏–ø—Ç–æ–≤)
            contentArea.innerHTML = html;
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑–æ–≤—É—Ç –Ω—É–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–µ –≤—ã—à–µ)
            attachScheduleHandlers(role); 
            
        } else {
            contentArea.innerHTML = `<h1>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (${res.status})!</h1>`;
        }
    } catch (error) {
        contentArea.innerHTML = '<h1>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏! –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç.</h1>';
        console.error('Content load error:', error);
    }
}


// –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –ú–ï–ù–Æ (–ø–µ—Ä–µ–¥–∞–µ–º —Ä–æ–ª—å –≤ loadContent)
document.getElementById('scheduleLink').addEventListener('click', (e) => {
    e.preventDefault();
    const currentRole = document.getElementById('menuRole').textContent;
    
    let urlToLoad = '';
    if (currentRole === 'teacher') {
        urlToLoad = '/teacher_schedule.html';
    } else if (currentRole === 'student') {
        urlToLoad = '/student_schedule.html';
    } else {
        document.getElementById('contentArea').innerHTML = '<h1>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.</h1>';
        return;
    }
    
    // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–∫—É—â—É—é —Ä–æ–ª—å –≤ loadContent
    loadContent(urlToLoad, currentRole); 
});

async function loadStudentSchedule() {
            const msgBox = document.getElementById('scheduleMessage');
            const tableBody = document.getElementById('scheduleTableBody');
            
            tableBody.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É

            console.log("--- 1. —Ñ—É–Ω–∫—Ü–∏—è loadstudentSchedule –∑–∞–ø—É—â–µ–Ω–∞ ---");

            try {

                console.log("--- 2. –û—Ç–ø—Ä–∞–≤–∫–∞ fetch –∑–∞–ø—Ä–æ—Å–∞... ---");
                // –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –°–µ—Ä–≤–µ—Ä —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≥—Ä—É–ø–ø—É —Å—Ç—É–¥–µ–Ω—Ç–∞.
                const res = await fetch("/api/get_schedule");

                console.log("--- 3. Fetch –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç! ---");
                const data = await res.json();

                console.log("Schedule response:", data);
                
                if (data.success && data.schedule && data.schedule.length > 0) {
                    msgBox.textContent = `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã: ${data.group}`;
                    msgBox.style.color = 'green';
                    document.getElementById('scheduleTitle').textContent = `–í–∞—à–µ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (${data.group})`;
                    
                    let currentDay = '';
                    
                    data.schedule.forEach(lesson => {
                        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
                        if (lesson.day_of_week !== currentDay) {
                            currentDay = lesson.day_of_week;
                            const dayRow = document.createElement('tr');
                            dayRow.innerHTML = `<td colspan="4" class="day-header">${currentDay}</td>`;
                            tableBody.appendChild(dayRow);
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —É—Ä–æ–∫–∞
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${lesson.time_slot}</td>
                            <td style="text-align: left;">${lesson.course}</td>
                            <td>${lesson.classroom}</td>
                            <td>${lesson.teacher_name}</td>
                        `;
                        tableBody.appendChild(row);
                    });

                } else {
                    msgBox.textContent = data.error || `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã ${data.group || '–í–∞—à–µ–π –≥—Ä—É–ø–ø—ã'} –ø–æ–∫–∞ –Ω–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–æ.`;
                    msgBox.style.color = 'red';
                }

            } catch (error) {
                console.error("Schedule load error:", error);
                msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.';
                msgBox.style.color = 'red';
            }
        };

    </script>
</body>
</html>