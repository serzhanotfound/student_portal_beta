<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Главная страница | Портал</title>
    
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales/ru.js'></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f9; display: flex; }
        
        .sidebar {
            width: 250px;
            background-color: #8b0000;
            color: white;
            min-height: 100vh;
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            position: fixed;
        }
        .user-info {
            display: flex;
            flex-direction: column;
            align-items: center;

            width: 100%; 
            padding: 15px 0;
        }
        .user-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-size: cover;
            background-position: center; 
            background-repeat: no-repeat; 
            margin-bottom: 5px; 
            background-image: url('/assets/default_avatar.jpg'); 

            display: flex; 
            justify-content: center;
            align-items: center;
        }
        .user-info p {
            margin: 0;
            font-size: 14px;
        }
        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            color: white;
            display: block;
        }
        .menu-item:hover {
            background-color: #a52a2a;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            flex-grow: 1;
        }
        .main-content h1 {
            color: #333;
        }

.results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
    gap: 25px; 
    margin-top: 20px;
}

.result-card {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    height: 220px; 
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.result-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
}

.card-title {
    font-size: 1.2em;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 10px;
}

.card-rating-label {
    font-size: 0.9em;
    color: #7f8c8d;
    margin-bottom: 5px;
}

.card-grade {
    font-size: 4em;
    font-weight: 900;
    color: #e74c3c;
    flex-grow: 1; 
    display: flex;
    align-items: center;
    justify-content: center;
}

.card-teacher {
    font-size: 0.85em;
    color: #34495e;
    border-top: 1px solid #ecf0f1;
    padding-top: 10px;
    margin-top: 10px;
}


.loading-message, .no-results-message {
    width: 100%; 
    text-align: center;
    padding: 20px;
    background-color: #f0f0f0;
    border-radius: 8px;
    color: #34495e;
    font-weight: bold;
    box-sizing: border-box;
}
.action-btn {
    padding: 10px 20px;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}
.action-btn:hover {
    background-color: #2980b9;
}

.grading-tabs {
    display: flex;
    margin-bottom: 15px;
    border-bottom: 2px solid #ddd;
}

.tab-button {
    padding: 10px 15px;
    cursor: pointer;
    background-color: #f4f4f4;
    border: 1px solid #ddd;
    border-bottom: none;
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
    margin-right: 5px;
    font-weight: bold;
    transition: background-color 0.3s;
}

.tab-button.active {
    background-color: #fff;
    border-color: #ddd;
    border-bottom: 2px solid #fff;
}

.grading-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.grading-table th, .grading-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
    white-space: nowrap;
}

.grading-table thead th {
    background-color: #f2f2f2;
    font-size: 12px;
}

.table-scroll {
    overflow-x: auto;
}

.grade-input {
    padding: 3px;
    text-align: center;
}
.tabs-nav {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 2px solid #ccc;
}
.tab-button {
    background: none;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 16px;
    border-bottom: 2px solid transparent;
    transition: all 0.3s;
}
.tab-button.active {
    border-bottom: 2px solid #8b0000;
    color: #8b0000;
    font-weight: bold;
}
.tab-pane {
    display: none;
    padding-top: 15px;
}
.tab-pane.active {
    display: block;
}
.assessment-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}
.assessment-table th, .assessment-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
}
.assessment-table th {
    background-color: #f2f2f2;
    font-weight: bold;
}
.score-value.not-set {
    color: #999;
}
.summary-box {
    border: 1px solid #8b0000;
    padding: 20px;
    margin-top: 20px;
    background-color: #fff0f0;
    border-radius: 8px;
}
.final-grade-line {
    font-size: 1.2em;
    margin: 10px 0;
}
.final-percent-value {
    color: #000080;
    font-weight: bold;
    margin-left: 10px;
}
.final-letter-value {
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 4px;
    color: white;
}

.grade-a { background-color: #27ae60; }
.grade-b { background-color: #2980b9; }
.grade-c { background-color: #f39c12; }
.grade-d { background-color: #d35400; }
.grade-f { background-color: #c0392b; }

.widget-grid {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
}


.widget-card {
    flex: 1;
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-left: 5px solid #8b0000;
}

.widget-card h3 {
    margin-top: 0;
    color: #8b0000;
    font-size: 1.2em;
}

.widget-card p {
    font-size: 1.5em;
    font-weight: bold;
    color: #34495e;
}

#calendar {
    max-width: 100%;
    margin: 0 auto;
    padding: 20px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.news-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}

.news-card {
    background-color: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
    text-decoration: none; 
    color: #333;
}

.news-card:hover {
    transform: translateY(-5px);
}

.news-image {
    width: 100%;
    height: 150px;
    object-fit: cover;
}

.news-content {
    padding: 15px;
}

.news-content h3 {
    margin-top: 0;
    font-size: 1.1em;
    color: #8b0000;
    height: 3.3em;
    overflow: hidden;
}

.news-content p {
    font-size: 0.9em;
    color: #555;
    margin: 5px 0 0 0;
}
    </style>

</head>
<body>
    <div class="sidebar"> 
        <div class="user-info">
            <div id="mainMenuAvatar" class="user-icon"></div>
            <p id="menuUsername">username</p>
            <p id="menuRole">role</p>
        </div>
        <a href="#" class="menu-item active-menu" id="homeLink">Главная</a>
        <a href="#" class="menu-item" id="profileLink">Профиль</a>
        <a href="#" class="menu-item" id="courseLink">Курсы</a>
        <a href="#" class="menu-item" id="scheduleLink">Расписание</a>
        <a href="#" class="menu-item" id="resultsLink">Результаты</a>
        <a href="#" class="menu-item" id="logoutLink">Выйти</a>
    </div>

    <div class="main-content">
        <div id="contentArea">

        </div>
    </div>

    <div id="messageModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h2 id="modalSubject">Заголовок сообщения</h2>
                    <p class="modal-meta" style="color: #bdc3c7;">Отправитель: <span id="modalSender"></span> | Дата: <span id="modalDate"></span></p>
                    <hr>
                    <div id="modalBody" style="white-space: pre-wrap; margin-top: 20px;">
                        ⏳ Загрузка...
                    </div>
                    <div class="modal-footer" style="margin-top: 30px; text-align: right;">
                        <button id="deleteMessageBtn" class="action-btn delete-btn" style="background-color: #e74c3c;">Удалить</button>
                    </div>
                </div>
    </div>
    
    
    <script>

let USER_ROLE= 'student';

async function loadProfile() {
    try {
        const profileRes = await fetch("/profile");
        
        if (profileRes.status === 401) {
            window.location.href = '/'; 
            return;
        }

        const userData = await profileRes.json();
        
        document.getElementById('menuUsername').textContent = userData.username;
        document.getElementById('menuRole').textContent = userData.role;
        userRole = userData.role;
        window.userData = userData;

        renderHomePage(userData);

    } catch (error) {
        console.error("Ошибка загрузки профиля:", error);
        window.location.href = '/'; 
    }
}

 document.getElementById('logoutLink').addEventListener('click', async (e) => {
            e.preventDefault();
            setActiveMenu(e.currentTarget);
            
            await fetch('/logout', { method: 'POST' });
            
            window.location.href = '/'; 
        });

        loadProfile();
async function saveSchedule() {
    const groupName = document.getElementById('groupSelector').value;
    const dayOfWeek = document.getElementById('daySelector').value;
    const msgBox = document.getElementById('scheduleMessage');
    const tableBody = document.getElementById('scheduleInputTable').querySelector('tbody');
    const rows = tableBody.querySelectorAll('tr');

    const lessons = [];

    rows.forEach(row => {
        const timeSlot = row.getAttribute('data-time');
        const course = row.querySelector('input[data-field="course"]').value.trim();
        const classroom = row.querySelector('input[data-field="classroom"]').value.trim();
        
        if (course || classroom) {
            lessons.push({ time_slot: timeSlot, 
                course: course || '', 
                classroom: classroom || '' });
        }
    });

    if (lessons.length === 0) {
        msgBox.textContent = '❌ Заполните хотя бы одно поле для сохранения.';
        msgBox.style.color = 'red';
        return;
    }

    try {
        msgBox.textContent = '⏳ Сохранение...';
        msgBox.style.color = 'orange';

        const res = await fetch("/api/save_schedule", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ groupName, dayOfWeek, lessons })
        });

        const data = await res.json();
        
        if (data.success) {
            msgBox.textContent = `✅ Расписание для ${groupName} (${dayOfWeek}) успешно сохранено!`;
            msgBox.style.color = 'green';
        } else {
            msgBox.textContent = '❌ Ошибка сохранения: ' + (data.error || 'Неизвестная ошибка.');
            msgBox.style.color = 'red';
        }

    } catch (error) {
        console.error("Save schedule error:", error);
        msgBox.textContent = '❌ Ошибка сети при сохранении.';
        msgBox.style.color = 'red';
    }
}

async function loadTeacherSchedule() {
    
    const group = document.getElementById('groupSelector').value;
    const day = document.getElementById('daySelector').value;
    const msgBox = document.getElementById('scheduleMessage');
    
    
    const tableBody = document.getElementById('scheduleInputTable').querySelector('tbody');
    tableBody.querySelectorAll('input').forEach(input => input.value = '');

    if (!group || !day) {
        msgBox.textContent = 'Выберите группу и день недели для загрузки.';
        msgBox.style.color = 'blue';
        return;
    }
    
    msgBox.textContent = `⏳ Загрузка расписания для ${group} (${day})...`;
    msgBox.style.color = 'orange';

    try {
        const res = await fetch(`/api/get_schedule?group=${group}&day=${day}`);
        const data = await res.json();
        
        if (data.success && data.schedule && data.schedule.length > 0) {
            
            data.schedule.forEach(lesson => {
                const row = tableBody.querySelector(`tr[data-time="${lesson.time_slot}"]`);
                if (row) {
                    row.querySelector('input[data-field="course"]').value = lesson.course;
                    row.querySelector('input[data-field="classroom"]').value = lesson.classroom;
                }
            });
            
            msgBox.textContent = `✅ Расписание для ${group} (${day}) загружено. Можно редактировать.`;
            msgBox.style.color = 'green';
            
        } else {
            msgBox.textContent = `⚠️ Расписание для ${group} (${day}) не найдено. Можно составить новое.`;
            msgBox.style.color = 'orange';
        }

    } catch (error) {
        console.error('Ошибка загрузки расписания для учителя:', error);
        msgBox.textContent = '❌ Ошибка сети при загрузке расписания.';
        msgBox.style.color = 'red';
    }
}

async function loadAdminCourses() {
    const tableBody = document.getElementById('coursesTableBody');
    const msgBox = document.getElementById('coursesMessage');
    const saveBtn = document.getElementById('saveCourseBtn');
    
    if (saveBtn) {
        saveBtn.removeEventListener('click', saveCourse); 
        saveBtn.addEventListener('click', saveCourse);
    }
    document.getElementById('cancelEditBtn').addEventListener('click', resetCourseForm);

    if (tableBody) tableBody.innerHTML = '';
    if (msgBox) msgBox.textContent = 'Загрузка курсов...';

    try {
        
        const res = await fetch("/api/get_all_courses");
        const data = await res.json();
        
        if (!data.success || !data.courses || data.courses.length === 0) {
            if (msgBox) msgBox.textContent = 'Нет курсов для отображения.';
            return;
        }

        if (msgBox) msgBox.textContent = 'Всего курсов: ' + data.courses.length;
        
        data.courses.forEach(course => {
            const row = tableBody.insertRow();
            row.insertCell().textContent = course.id;
            row.insertCell().textContent = course.name;
            row.insertCell().textContent = course.group_name; 
            row.insertCell().textContent = course.semester;  
            row.insertCell().textContent = course.teacher_id;
            row.insertCell().textContent = course.credits;
            
            const actionsCell = row.insertCell();
            
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Изменить';
            editBtn.onclick = () => editCourse(course);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Удалить';
            deleteBtn.onclick = () => deleteCourse(course.id);
            
            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(deleteBtn);
        });

    } catch (error) {
        console.error("Error loading courses for Admin:", error);
        if (msgBox) msgBox.textContent = 'Ошибка сети! Не удалось загрузить курсы.';
    }
}

function attachContentHandlers(role) {
       if (document.getElementById('groupSelector') || document.getElementById('scheduleTableBody')) {
        
        if (role === 'teacher' || role === 'admin') {
            const saveBtn = document.getElementById('saveScheduleBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveSchedule);
            }
            
            document.getElementById('groupSelector')?.addEventListener('change', loadTeacherSchedule);
            document.getElementById('daySelector')?.addEventListener('change', loadTeacherSchedule);
            
            loadTeacherSchedule(); 

        } else if (role === 'student') {
            loadStudentSchedule();
        }
    }
    initializeAdminFormBinding();
    if (document.getElementById('coursesTableBody')) {
         
        if (role === 'admin') {
            loadAdminCourses(); 
        } else {
            loadCourses(); 

             if (role === 'student') {
                const selector = document.getElementById('semesterSelector');
                    if (selector) {
                    selector.removeEventListener('change', loadCourses);
                    selector.addEventListener('change', loadCourses); 
                }
                }
        }
    }
    if (document.querySelector('.profile-layout')) { 
        if (role === 'student' || role === 'teacher' || role === 'admin') { 
            
            loadProfileData(); 
            attachProfileNavigation(); 
        }
        const form = document.getElementById('changePasswordForm');
        if (form) {
            form.removeEventListener('submit', changePassword);
            form.addEventListener('submit', changePassword); 
        }

        const photoForm = document.getElementById('changePhotoForm');
        const fileInput = document.getElementById('avatarFile');

        if (photoForm && fileInput) {
            photoForm.removeEventListener('submit', uploadAvatar);
            photoForm.addEventListener('submit', uploadAvatar);
            
            fileInput.removeEventListener('change', updateFileNameDisplay);
            fileInput.addEventListener('change', updateFileNameDisplay);
        }
    }
}

function resetCourseForm() {
    document.getElementById('courseId').value = '';
    document.getElementById('courseName').value = '';
    document.getElementById('courseDescription').value = '';
    document.getElementById('courseCredits').value = '';
    document.getElementById('courseTeacherId').value = '';
    document.getElementById('courseGroup').value = '';
    document.getElementById('courseSemester').value = '';
    document.getElementById('saveCourseBtn').textContent = 'Сохранить Курс';
    document.getElementById('formMessage').textContent = '';
    document.getElementById('cancelEditBtn').style.display = 'none';
}

function editCourse(course) {
    document.getElementById('courseId').value = course.id;
    document.getElementById('courseName').value = course.name;
    document.getElementById('courseDescription').value = course.description;
    document.getElementById('courseCredits').value = course.credits;
    document.getElementById('courseTeacherId').value = course.teacher_id;
    document.getElementById('courseGroup').value = course.group_name;
    document.getElementById('courseSemester').value = course.semester;
    
    document.getElementById('saveCourseBtn').textContent = 'Обновить Курс';
    document.getElementById('cancelEditBtn').style.display = 'inline';
    document.getElementById('formMessage').textContent = 'Редактирование курса: ' + course.name;
}

async function saveCourse() {
    const teacherIdElement = document.getElementById('courseTeacherId');
    const msgBox = document.getElementById('formMessage');

    if (!teacherIdElement) {
        if (msgBox) {
            msgBox.textContent = '❌ Ошибка: Форма курса не инициализирована полностью.';
        }
        
        return;
    }
    
    
    const courseId = document.getElementById('courseId').value || null;
    const name = document.getElementById('courseName').value.trim();
    const group_name = document.getElementById('courseGroup').value.trim(); 
    const semester = parseInt(document.getElementById('courseSemester').value.trim()); 

    const description = document.getElementById('courseDescription').value.trim();
    const credits = parseInt(document.getElementById('courseCredits').value.trim());
    const teacher_id = parseInt(teacherIdElement.value.trim());

    if (!name || isNaN(credits) || isNaN(teacher_id) || !group_name || isNaN(semester)) {
        msgBox.textContent = '❌ Заполните все поля корректно.';
        return;
    }

    try {
        msgBox.textContent = '⏳ Сохранение...';
        const res = await fetch("/api/save_course", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: courseId, name, description, credits, teacher_id, group_name, semester })
        });
        
        const data = await res.json();
        
        if (data.success) {
            msgBox.textContent = `✅ Курс успешно ${courseId ? 'обновлен' : 'добавлен'}!`;
            resetCourseForm();
            loadAdminCourses();
        } else {
            msgBox.textContent = '❌ Ошибка сохранения: ' + (data.error || 'Неизвестная ошибка.');
        }

    } catch (error) {
        console.error("Save course error:", error);
        msgBox.textContent = '❌ Ошибка сети при сохранении.';
    }
}

async function deleteCourse(id) {
    if (!confirm('Вы уверены, что хотите удалить этот курс?')) return;
    
    const msgBox = document.getElementById('coursesMessage');
    msgBox.textContent = '⏳ Удаление...';

    try {
        const res = await fetch("/api/delete_course", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id })
        });
        
        const data = await res.json();
        
        if (data.success) {
            msgBox.textContent = `✅ Курс ID ${id} успешно удален.`;
            loadAdminCourses();
        } else {
            msgBox.textContent = '❌ Ошибка удаления: ' + (data.error || 'Неизвестная ошибка.');
        }

    } catch (error) {
        console.error("Delete course error:", error);
        msgBox.textContent = '❌ Ошибка сети при удалении.';
    }
}

async function loadContent(path) {
     let targetFile = '';
    
    if (path === '/schedule') {
        if (userRole === 'teacher' || userRole === 'admin') {
        targetFile = 'teacher_schedule.html';
        } else {
            targetFile = 'student_schedule.html';
        }
    } else if (path === '/profile') {
        if(userRole === 'admin' ){
            targetFile = 'admin_profile.html';}
        else{
        targetFile = userRole === 'teacher' ? 'teacher_profile.html' : 'student_profile.html';
        }
    }
    
    else if (path === '/courses') {
        if (userRole === 'admin') {
            targetFile = 'admin_courses.html';}
        else{
        targetFile = userRole === 'teacher' ? 'teacher_courses.html' : 'student_courses.html';}
    } 
    else {
        console.error('Unknown path:', path);
        document.getElementById('contentArea').innerHTML = '<p style="color: red;">Неизвестный пункт меню.</p>';
        return;
    }

    try {
        const res = await fetch(targetFile);
        if (!res.ok) throw new Error(`Failed to load ${targetFile} (${res.status})`);
        
        const html = await res.text();
        
        document.getElementById('contentArea').innerHTML = html; 
        attachContentHandlers(userRole);

        if (path === '/profile') {
            await loadProfileAndSetAvatar(); 
        }
        
    } catch (error) {
        console.error('Error loading content:', error);
        document.getElementById('contentArea').innerHTML = '<p style="color: red;">Ошибка загрузки контента: ' + error.message + '</p>';
    }
}

async function loadProfileData() {
    const contentHeader = document.getElementById('contentHeader');
    const msgBox = document.getElementById('personal-data-section');
    
    if (contentHeader) contentHeader.textContent = 'ЛИЧНЫЕ ДАННЫЕ (Загрузка...)';

    try {
        const res = await fetch("/api/get_profile_data");
        const data = await res.json();
        
        if (data.success && data.user) {
            const user = data.user;
            
            document.getElementById('profileUsername').textContent = user.username || 'N/A';
            
            document.getElementById('displayUsername').textContent = user.username || '—';
            document.getElementById('displayName').textContent = user.full_name || 'Не указано';
            document.getElementById('displayId').textContent = user.id || '—';
            document.getElementById('displayGroup').textContent = user.group_name || '—';
            
            document.getElementById('displayMajor').textContent = user.major || 'Не задано'; 
            document.getElementById('displayEntranceYear').textContent = user.entrance_year || 'Не задан';

            if (contentHeader) contentHeader.textContent = 'ЛИЧНЫЕ ДАННЫЕ';
        } else {
            if (msgBox) msgBox.innerHTML = '<p style="color:red;">Ошибка загрузки данных профиля: ' + (data.error || 'Неизвестная ошибка') + '</p>';
            if (contentHeader) contentHeader.textContent = 'ОШИБКА';
        }
    } catch (error) {
        console.error("Profile load error:", error);
        if (msgBox) msgBox.innerHTML = '<p style="color:red;">❌ Ошибка сети при загрузке профиля.</p>';
        if (contentHeader) contentHeader.textContent = 'ОШИБКА СЕТИ';
    }
}

document.getElementById('homeLink').addEventListener('click', (e) => {
    e.preventDefault();
    renderHomePage(window.userData);
    setActiveMenu(e.currentTarget);
});

document.getElementById('scheduleLink').addEventListener('click', (e) => {
    e.preventDefault();
    loadContent('/schedule');
    setActiveMenu(e.currentTarget);
});

document.getElementById('courseLink').addEventListener('click', (e) => {
    e.preventDefault();
    loadContent('/courses');
    setActiveMenu(e.currentTarget);
});

document.getElementById('profileLink').addEventListener('click', (e) => {
    e.preventDefault();
    loadContent('/profile');
    setActiveMenu(e.currentTarget);
});

async function loadStudentSchedule() {
            const msgBox = document.getElementById('scheduleMessage');
            const tableBody = document.getElementById('scheduleTableBody');
            
            tableBody.innerHTML = '';

            console.log("--- 1. функция loadstudentSchedule запущена ---");

            try {

                console.log("--- 2. Отправка fetch запроса... ---");
                const res = await fetch("/api/get_schedule");

                console.log("--- 3. Fetch вернул ответ! ---");
                const data = await res.json();

                console.log("Schedule response:", data);
                
                if (data.success && data.schedule && data.schedule.length > 0) {
                    msgBox.textContent = `Расписание для группы: ${data.group}`;
                    msgBox.style.color = 'green';
                    document.getElementById('scheduleTitle').textContent = `Ваше Расписание (${data.group})`;
                    
                    let currentDay = '';
                    
                    data.schedule.forEach(lesson => {
     
                        if (lesson.day_of_week !== currentDay) {
                            currentDay = lesson.day_of_week;
                            const dayRow = document.createElement('tr');
                            dayRow.innerHTML = `<td colspan="4" class="day-header">${currentDay}</td>`;
                            tableBody.appendChild(dayRow);
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${lesson.time_slot}</td>
                            <td style="text-align: left;">${lesson.course}</td>
                            <td>${lesson.classroom}</td>
                            <td>${lesson.teacher_name}</td>
                        `;
                        tableBody.appendChild(row);
                    });

                } else {
                    msgBox.textContent = data.error || `Расписание для группы ${data.group || 'Вашей группы'} пока не составлено.`;
                    msgBox.style.color = 'red';
                }

            } catch (error) {
                console.error("Schedule load error:", error);
                msgBox.textContent = '❌ Ошибка сети при загрузке расписания.';
                msgBox.style.color = 'red';
            }
        };

async function loadCourses() {
    const tableBody = document.getElementById('coursesTableBody');
    const msgBox = document.getElementById('coursesMessage');
    
    const role = userRole;

    if (tableBody) tableBody.innerHTML = ''; 
    if (msgBox) msgBox.textContent = 'Загрузка данных...';

    try {
        let apiUrl = "/api/get_courses"

        if(role === 'student') {
            const semesterSelector = document.getElementById('semesterSelector');
            const selectedSemester = semesterSelector ? semesterSelector.value : '1';
            
            apiUrl = `/api/get_courses?semester=${selectedSemester}`; 
        }
        const res = await fetch(apiUrl);
        const data = await res.json();
        
        if (!data.success || !data.courses || data.courses.length === 0) {
            if (msgBox) msgBox.textContent = 'Список курсов не найден.';
            return;
        }
        

        if (msgBox) msgBox.textContent = '';

       if (data.role === 'student') {
                const tableBody = document.getElementById('coursesTableBody');
                if (tableBody) tableBody.innerHTML = '';
                
                data.courses.forEach(course => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = course.course_name;
                    row.insertCell().textContent = course.teacher_name; 
                    row.insertCell().textContent = course.credits;
                    row.insertCell().textContent = course.description || '—';
                });
        } else if (data.role === 'teacher') {
            data.courses.forEach(course => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = course.course_name;
                row.insertCell().textContent = course.credits;
                row.insertCell().textContent = course.groups_taught || 'Нет групп';
            });
        }

    } catch (error) {
        console.error("Error loading courses:", error);
        if (msgBox) msgBox.textContent = 'Ошибка сети! Не удалось загрузить курсы.';
    }
}

function attachProfileNavigation() {
    const navButtons = document.querySelectorAll('.profile-nav-btn');
    const sections = document.querySelectorAll('.profile-section');
    const contentHeader = document.getElementById('contentHeader');

    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetSectionId = button.getAttribute('data-section');
            const targetHeader = button.textContent;

            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            sections.forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(targetSectionId + '-section').style.display = 'block';
            
            if (contentHeader) contentHeader.textContent = targetHeader.toUpperCase();
            
            if (targetSectionId === 'personal-data') {
                loadProfileData(); 
            }
        });
    });
}

async function changePassword(e) {
    e.preventDefault();

    const currentPass = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmNewPassword').value;
    const msgBox = document.getElementById('passwordMessage');
    
    msgBox.textContent = ''; 

    if (newPass.length < 6) {
        msgBox.textContent = '❌ Новый пароль должен содержать минимум 6 символов.';
        msgBox.style.color = 'red';
        return;
    }
    
    if (newPass !== confirmPass) {
        msgBox.textContent = '❌ Новый пароль и его подтверждение не совпадают.';
        msgBox.style.color = 'red';
        return;
    }

    if (currentPass === newPass) {
        msgBox.textContent = '❌ Новый пароль не должен совпадать с текущим.';
        msgBox.style.color = 'red';
        return;
    }

    msgBox.textContent = '⏳ Отправка запроса...';
    msgBox.style.color = 'orange';

    try {
        const res = await fetch("/api/change_password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                currentPassword: currentPass, 
                newPassword: newPass 
            })
        });

        const data = await res.json();

        if (data.success) {
            msgBox.textContent = '✅ Пароль успешно изменен!';
            msgBox.style.color = 'green';
            document.getElementById('changePasswordForm').reset();
        } else {
            msgBox.textContent = '❌ Ошибка: ' + (data.error || 'Неизвестная ошибка сервера.');
            msgBox.style.color = 'red';
        }
    } catch (error) {
        console.error("Change password error:", error);
        msgBox.textContent = '❌ Ошибка сети при смене пароля.';
        msgBox.style.color = 'red';
    }
}

function updateFileNameDisplay() {
    const fileInput = document.getElementById('avatarFile');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    
    if (fileInput.files.length > 0) {
        fileNameDisplay.textContent = fileInput.files[0].name;
    } else {
        fileNameDisplay.textContent = 'Файл не выбран';
    }
}    
    

async function uploadAvatar(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('avatarFile');
    const msgBox = document.getElementById('photoMessage');
    
    if (fileInput.files.length === 0) {
        msgBox.textContent = '❌ Пожалуйста, выберите файл для загрузки.';
        msgBox.style.color = 'red';
        return;
    }

    const file = fileInput.files[0];
    if (file.size > 5 * 1024 * 1024) {
        msgBox.textContent = '❌ Файл слишком большой (макс. 5 МБ).';
        msgBox.style.color = 'red';
        return;
    }
    
    msgBox.textContent = '⏳ Загрузка файла...';
    msgBox.style.color = 'orange';

    const formData = new FormData();
    formData.append('avatar', file);

    try {
        const res = await fetch("/api/upload_avatar", {
            method: "POST",
            body: formData 
        });

        const data = await res.json();
        
        if (res.status === 200 && data.success) {
            msgBox.textContent = '✅ Аватар успешно обновлен!';
            msgBox.style.color = 'green';
            
            const currentAvatar = document.getElementById('currentAvatar');

             const newAvatarUrl = data.filePath + '?t=' + new Date().getTime();
             document.getElementById('currentAvatar').src = newAvatarUrl;

            const sidebarAvatar = document.getElementById('sidebarAvatar'); 
            if (sidebarAvatar) {
                sidebarAvatar.style.backgroundImage = `url('${newAvatarUrl}')`; 
            }

            const mainMenuAvatar = document.getElementById('mainMenuAvatar');
            if (mainMenuAvatar) {
                mainMenuAvatar.style.backgroundImage = `url('${newAvatarUrl}')`;
            }
            
            document.getElementById('changePhotoForm').reset();
            document.getElementById('fileNameDisplay').textContent = 'Файл не выбран';

        } else {
            msgBox.textContent = '❌ Ошибка: ' + (data.error || 'Неизвестная ошибка загрузки.');
            msgBox.style.color = 'red';
        }
    } catch (error) {
        console.error("Upload error:", error);
        msgBox.textContent = '❌ Ошибка сети при загрузке аватара.';
        msgBox.style.color = 'red';
    }
}

async function loadProfileAndSetAvatar() {
   try {
        const response = await fetch('/api/get_profile_data');
        const data = await response.json();
    console.log('Response JSON:', data);

        if (data.success) {
            const user = data.user;
            window.userRole = user.role;

            const avatarPath = user.avatar_path || '/assets/default_avatar.jpg';
            const avatarUrl = avatarPath + '?t=' + new Date().getTime(); 

            const currentAvatar = document.getElementById('currentAvatar');
            if (currentAvatar) {
                currentAvatar.src = avatarUrl;
            }

            const sidebarAvatar = document.getElementById('sidebarAvatar'); 
            if (sidebarAvatar) {
                sidebarAvatar.style.backgroundImage = `url('${avatarUrl}')`;
            }

            const mainMenuAvatar = document.getElementById('mainMenuAvatar'); 
            if (mainMenuAvatar) {
                mainMenuAvatar.style.backgroundImage = `url('${avatarUrl}')`;
            }
            
            const profileUsernameElement = document.getElementById('profileUsername');
            if (profileUsernameElement) {
                profileUsernameElement.textContent = user.username;
            }

            const avatarUsernameDisplayElement = document.getElementById('avatarUsernameDisplay');
            if (avatarUsernameDisplayElement) {
                avatarUsernameDisplayElement.textContent = user.username;
            }
            
        } else if (response.status === 401) {
            window.location.href = '/'; 
        } else {
            console.error("Ошибка загрузки профиля:", data.error);
        }
    } catch (error) {
        console.error("Сетевая ошибка при загрузке профиля:", error);
    }
}

// document.addEventListener('DOMContentLoaded', loadProfileAndSetAvatar);

async function sendAdminMessage(e) {
    e.preventDefault();
    console.log("Submit event stopped. Sending via Fetch.");

    const subject = document.getElementById('subjectInput').value.trim();
    const message = document.getElementById('messageTextarea').value.trim();
    const resultBox = document.getElementById('adminMessageStatus'); 

    if (!subject || !message) {
        resultBox.textContent = '❌ Пожалуйста, заполните все поля.';
        resultBox.style.color = 'red';
        return;
    }

    resultBox.textContent = '⏳ Отправка...';
    resultBox.style.color = 'orange';

    try {
        console.log('Sending admin message', { subject, message });
        const response = await fetch('/api/send_admin_message', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ subject, message })
        });
        console.log('Fetch completed, status =', response.status);

        const data = await response.json();

        if (response.status === 200 && data.success) {
            resultBox.textContent = '✅ Сообщение успешно отправлено!';
            resultBox.style.color = 'green';
            document.getElementById('adminMessageForm').reset();
        } else {
            resultBox.textContent = `❌ Ошибка: ${data.error || 'Неизвестная ошибка.'}`;
            resultBox.style.color = 'red';
        }
    } catch (error) {
        resultBox.textContent = '❌ Ошибка сети. Проверьте соединение.';
        resultBox.style.color = 'red';
        console.error("Network error sending admin message:", error);
    }
}

async function loadAdminMessages() {
    const container = document.getElementById('messagesListContainer');
    const status = document.getElementById('messagesStatus');
    
    
    container.innerHTML = '<p style="color: #f39c12; text-align: center;">⏳ Загрузка сообщений...</p>';
    status.textContent = '';

    try {
    
        const response = await fetch('/api/get_admin_messages', { 
            method: 'GET',
            credentials: 'same-origin' 
        });
        
        const data = await response.json();

        if (response.ok && data.success && Array.isArray(data.messages)) {
            if (data.messages.length === 0) {
                container.innerHTML = '<p style="color: #bdc3c7; text-align: center;">Входящих сообщений нет.</p>';
            } else {
                container.innerHTML = generateMessagesTable(data.messages);
            }
        } else {
            status.textContent = `❌ Ошибка загрузки: ${data.error || 'Неизвестная ошибка сервера.'}`;
            container.innerHTML = '';
        }
    } catch (error) {
        status.textContent = '❌ Ошибка сети. Не удалось загрузить сообщения.';
        container.innerHTML = '';
        console.error("Error loading admin messages:", error);
    }
}

async function loadAdminContent() {
    const response = await fetch('admin_profile.html');
    const htmlContent = await response.text();
    document.getElementById('mainContentContainer').innerHTML = htmlContent;
}

function generateMessagesTable(messages) {
    let html = '<table class="messages-table"><thead><tr>';
    html += '<th>ID</th><th>Отправитель</th><th>Тема</th><th>Дата</th><th>Статус</th><th>Действия</th>';
    html += '</tr></thead><tbody>';

    messages.forEach(msg => {
        const isRead = msg.is_read === 1; 
        const statusText = isRead ? 'Прочитано' : 'НЕ ПРОЧИТАНО';
        const statusClass = isRead ? 'status-read' : 'status-unread';
        
        html += `
            <tr data-message-id="${msg.id}" class="${statusClass}">
                <td>${msg.id}</td>
                <td>${msg.user_name || 'Студент'}</td>
                <td><a href="#" class="message-subject-link" data-id="${msg.id}">${msg.subject}</a></td>
                <td>${new Date(msg.created_at).toLocaleDateString()}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="action-btn view-btn" data-id="${msg.id}">Просмотр</button>
                    <button class="action-btn delete-btn" data-id="${msg.id}" style="background-color: #e74c3c;">Удалить</button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    return html;
}

async function showMessageModal(messageId) {
    const modal = document.getElementById('messageModal');
    const modalBody = document.getElementById('modalBody');
    
    
    modal.style.display = 'block';
    modalBody.innerHTML = '⏳ Загрузка сообщения...';
    
    
    document.getElementById('deleteMessageBtn').setAttribute('data-id', messageId);

    try {
        
        const response = await fetch(`/api/view_message?id=${messageId}`, { 
            method: 'GET',
            credentials: 'same-origin' 
        });
        
        const data = await response.json();

        if (response.ok && data.success && data.message) {
            const msg = data.message;
            
            document.getElementById('modalSubject').textContent = msg.subject;
            document.getElementById('modalSender').textContent = msg.user_name || 'Неизвестный';
            document.getElementById('modalDate').textContent = new Date(msg.created_at).toLocaleDateString();
            modalBody.textContent = msg.message;
            
            loadAdminMessages(); 
        } else {
            modalBody.innerHTML = `❌ Ошибка загрузки сообщения: ${data.error || 'Сообщение не найдено.'}`;
        }
    } catch (error) {
        modalBody.innerHTML = '❌ Ошибка сети. Не удалось загрузить сообщение.';
        console.error("Error loading single message:", error);
    }
}

function closeModal() {
    const modal = document.getElementById('messageModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

async function deleteMessageHandler(messageId) {
    if (!confirm('Вы уверены, что хотите удалить это сообщение? Это действие необратимо.')) {
        return;
    }

    const deleteBtn = document.getElementById('deleteMessageBtn');
    const originalText = deleteBtn.textContent;
    
    deleteBtn.textContent = 'Удаление...';
    deleteBtn.disabled = true;

    try {
        const response = await fetch('/api/delete_message', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: messageId })
        });
        
        const data = await response.json();

        if (response.ok && data.success) {
            alert('Сообщение успешно удалено!');
            closeModal();
            loadAdminMessages();
        } else {
            alert(`Ошибка удаления: ${data.error || 'Неизвестная ошибка.'}`);
        }
    } catch (error) {
        console.error("Error deleting message:", error);
        alert('Ошибка сети. Не удалось удалить сообщение.');
    } finally {
        deleteBtn.textContent = originalText;
        deleteBtn.disabled = false;
    }
}

function handleResultsClick() {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = '';

    if (window.userRole === 'teacher' || window.userRole === 'admin') {
        loadTeacherGradingInterface(); 
    } else if (window.userRole === 'student') {
        loadResultsOverview(); 
    } else {
        contentArea.innerHTML = '<h2 class="page-header">ОШИБКА</h2><p>Роль пользователя не определена.</p>';
    }
}

document.addEventListener('DOMContentLoaded', async () => {

    try {
        await loadProfileAndSetAvatar(); 
        
    } catch (e) {
        console.error("Ошибка при загрузке профиля/роли:", e);
    }
    
    switchProfileSection('personal-data');

    const resultsLink = document.getElementById('resultsLink');
    if (resultsLink) {
        resultsLink.addEventListener('click', (e) => {
            e.preventDefault();
            handleResultsClick(); 
        });
    }

    document.addEventListener('click', function(e) {
        
        const resultCard = e.target.closest('.result-card');
        if (resultCard) {
            const courseId = resultCard.getAttribute('data-course-id');
            const courseName = resultCard.querySelector('.card-title').textContent; 
            e.preventDefault(); 
            
            showCourseDetailsView(courseId, courseName);
        }
        
        if (e.target.id === 'backToOverviewBtn') {
            e.preventDefault();
            loadResultsOverview(); 
        }
    });
});

document.body.addEventListener('click', function(e) {

    if (e.target.matches('.profile-nav-btn')) {
        const sectionId = e.target.getAttribute('data-section');
        e.preventDefault(); 
        console.log(`DELEGATE: Клик по навигации: ${sectionId}`);
        switchProfileSection(sectionId);
    } 

    if (e.target.matches('.action-btn.view-btn') || e.target.matches('.message-subject-link')) {
        const messageId = e.target.getAttribute('data-id');
        e.preventDefault(); 
        if (messageId) {
            console.log(`DELEGATE: Вызов showMessageModal для ID: ${messageId}`);
            showMessageModal(messageId);
        }
    }
    
    if (e.target.matches('#deleteMessageBtn')) {
        const messageId = e.target.getAttribute('data-id'); 
        if (messageId) {
             console.log(`DELEGATE: Вызов deleteMessageHandler для ID: ${messageId}`);
            deleteMessageHandler(messageId); 
        }
    }
    
    if (e.target.matches('#messageModal .close-btn') || e.target.id === 'messageModal') {
        closeModal();
    }
});

window.onclick = function(event) {
    const modal = document.getElementById('messageModal');
    if (modal && event.target === modal) {
        closeModal();
    }
}

function initializeAdminFormBinding() {
    const adminForm = document.getElementById('adminMessageForm');

    if (adminForm && !adminForm.dataset.initialized) {
        adminForm.addEventListener('submit', sendAdminMessage);
        adminForm.dataset.initialized = 'true';
        console.log("Поиск формы Admin: УСПЕШНО ПРИВЯЗАНА!");
    }
}

function switchProfileSection(sectionId) {
    document.querySelectorAll('.profile-section').forEach(section => {
        section.style.display = 'none';
    });
    document.querySelectorAll('.profile-nav-btn').forEach(button => {
        button.classList.remove('active');
    });

    const targetSection = document.getElementById(sectionId + '-section');
    const targetButton = document.querySelector(`.profile-nav-btn[data-section="${sectionId}"]`);

    if (targetSection) {
        targetSection.style.display = 'block';
    }
    if (targetButton) {
        targetButton.classList.add('active');
    }
    const headerElement = document.getElementById('contentHeader');
    
    if (headerElement) {
        const headerMap = {
            'personal-data': 'ЛИЧНЫЕ ДАННЫЕ',
            'change-password': 'СМЕНА ПАРОЛЯ',
            'change-photo': 'СМЕНА ФОТО',
            'message-to-admin': 'СООБЩЕНИЕ АДМИНИСТРАТОРУ',
            'view-messages': 'ВХОДЯЩИЕ СООБЩЕНИЯ'
        };
        headerElement.textContent = headerMap[sectionId] || sectionId.toUpperCase();
    }

    if (sectionId === 'message-to-admin') {
        const messageSection = document.getElementById('message-to-admin-section');
        
        if (messageSection && messageSection.style.display === 'block') {
             initializeAdminFormBinding();
        }
    }
    else if (sectionId === 'view-messages') { 
    const adminMessageSection = document.getElementById('view-messages-section'); 
        
        if (adminMessageSection) {
            console.log("DEBUG: Вызов loadAdminMessages для 'view-messages'");
            loadAdminMessages();
        }
    }
}

function renderResultCard(item) {
    let gradeColor = '#27ae60'; // A
    if (item.letterGrade.startsWith('F')) {
        gradeColor = '#e74c3c'; // F
    } else if (item.letterGrade.startsWith('D') || item.letterGrade.startsWith('C')) {
        gradeColor = '#f39c12'; // D/C
    }
    
    const ratingDisplay = item.currentRating === 'Нет данных' 
                          ? `<span style="color:#e74c3c;">${item.currentRating}</span>` 
                          : `Текущий рейтинг: ${item.currentRating}`;
                          
    return `
        <div class="result-card" data-course-id="${item.courseId}">
            <div class="card-title">${item.title}</div>
            <div class="card-rating-label">${ratingDisplay}</div>
            
            <div class="card-grade" style="color: ${gradeColor};">${item.letterGrade}</div> 
            
            <div class="card-teacher">Преподаватель: ${item.teacherName}</div>
        </div>
    `;
}

async function loadResultsOverview() {
    const container = document.getElementById('contentArea');
    
    container.innerHTML = `
        <h2 class="page-header">ОБЗОР РЕЗУЛЬТАТОВ ПО КУРСАМ</h2>
        <div id="results-overview-container" class="results-grid">
            <div class="loading-message">Загрузка результатов...</div>
        </div>
        <div id="course-details-section" class="details-view" style="display:none;">
            <button id="backToOverviewBtn" class="action-btn">← Назад к обзору</button>
            <h4 id="detailsTitle" style="margin-top: 20px;">Детальные оценки по курсу: </h4>
            <div id="details-table-container"></div>
        </div>
    `;
    
    const overviewContainer = document.getElementById('results-overview-container');

    try {
        const response = await fetch('/api/student/results/overview');
        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || "Ошибка при получении данных с сервера.");
        }

        const resultsData = result.data;
        
        if (resultsData.length === 0) {
            overviewContainer.innerHTML = '<div class="no-results-message">На данный момент результаты по курсам отсутствуют.</div>';
            return;
        }

        let cardsHtml = '';
        resultsData.forEach(item => {
            cardsHtml += renderResultCard(item);
        });
        
        overviewContainer.innerHTML = cardsHtml;

    } catch (error) {
        console.error("Error loading student results:", error);
        overviewContainer.innerHTML = `<div class="error-message">Не удалось загрузить результаты: ${error.message}</div>`;
    }
}

async function showCourseDetailsView(courseId, courseName) {
    document.getElementById('results-overview-container').style.display = 'none';
    
    const detailsSection = document.getElementById('course-details-section');
    detailsSection.style.display = 'block';
    
    document.getElementById('detailsTitle').textContent = `Детальные оценки по курсу: ${courseName}`;
    const container = document.getElementById('details-table-container');
    container.innerHTML = '<p class="loading-message">Загрузка детальной информации...</p>';

    try {
        const response = await fetch(`/api/student/results/details/${courseId}`);

        if (!response.ok) {
            const errorText = await response.text();
            console.error("Сервер вернул ошибку, но не JSON (возможно, HTML):", errorText);
            throw new Error(`Ошибка сервера. Статус: ${response.status}`);
        }

        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || "Ошибка при получении данных с сервера.");
        }

        const groupedData = result.data;
        
        if (Object.keys(groupedData).length === 0) {
            container.innerHTML = '<div class="no-results-message">Шаблоны оценок по этому курсу не настроены или оценки не проставлены.</div>';
            return;
        }

        container.innerHTML = `
            <div class="tabs-container">
                <div class="tabs-nav">
                    <button class="tab-button active" data-tab="summary">Общая сводка</button>
                    <button class="tab-button" data-tab="weekly">Недельные Оценки</button>
                    <button class="tab-button" data-tab="srsp">СРСП</button>
                    <button class="tab-button" data-tab="final">Итоговые Оценки</button>
                </div>
                <div class="tabs-content">
                    <div id="tab-summary-content" class="tab-pane active"></div>
                    <div id="tab-weekly-content" class="tab-pane"></div>
                    <div id="tab-srsp-content" class="tab-pane"></div>
                    <div id="tab-final-content" class="tab-pane"></div>
                </div>
            </div>
        `;
        
        const allAssessments = [];
        Object.keys(groupedData).forEach(key => allAssessments.push(...groupedData[key]));
        
        const weeklyTransformedData = {};
        
        allAssessments.forEach(item => {
            if (item.category === 'Недельные') {
                const match = item.assessment_name.match(/Неделя (\d+)/);
                const week = match ? parseInt(match[1]) : 0;
                
                if (week > 0) {
                    if (!weeklyTransformedData[week]) {
                        weeklyTransformedData[week] = {};
                    }
                    if (item.subcategory === 'Практика') {
                        weeklyTransformedData[week].practice = item;
                    } else if (item.subcategory === 'Лекции') {
                        weeklyTransformedData[week].lecture = item;
                    }
                }
            }
        });
        
        const summary = calculateOverallSummary(allAssessments);

        document.getElementById('tab-summary-content').innerHTML = renderSummaryTab(summary);
        document.getElementById('tab-weekly-content').innerHTML = renderWeeklyTable(weeklyTransformedData);
        document.getElementById('tab-srsp-content').innerHTML = renderStudentResultsTable(groupedData['СРСП'] || [], 'СРСП');
        document.getElementById('tab-final-content').innerHTML = renderStudentResultsTable(groupedData['Итоговые'] || [], 'Итоговые Оценки');

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                activateTab(this.dataset.tab);
            });
        });

    } catch (error) {
        console.error("Error loading student assessment details:", error);
        container.innerHTML = `<div class="error-message">Не удалось загрузить детальные оценки: ${error.message}</div>`;
    }
}

window.assessmentData = {
    students: [],
    assessments: [],
    grades: {}
};


async function loadTeacherGradingInterface() {
    const container = document.getElementById('contentArea');
    container.innerHTML = `
        <h2 class="page-header">ВЫСТАВЛЕНИЕ ОЦЕНОК</h2>
        <div class="filter-controls" style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
            <label for="courseSelect">Курс:</label>
            <select id="courseSelect" style="padding: 8px; margin-right: 20px;"></select>
            
            <label for="groupSelect">Группа:</label>
            <select id="groupSelect" style="padding: 8px; margin-right: 20px;" disabled></select>
            
            <button id="loadAssessmentDataBtn" class="action-btn" style="background-color: #3498db;" disabled>Загрузить таблицу</button>
        </div>
        
        <div id="assessmentDataContainer">
            <p class="loading-message">Выберите курс и группу для начала.</p>
        </div>
    `;

    const courseSelect = document.getElementById('courseSelect');
    const groupSelect = document.getElementById('groupSelect');
    const loadBtn = document.getElementById('loadAssessmentDataBtn');
    const dataContainer = document.getElementById('assessmentDataContainer');
    
    try {
        courseSelect.innerHTML = '<option>Загрузка...</option>';
        const response = await fetch('/api/teacher/courses');
        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || "Ошибка при получении данных о курсах.");
        }
        
        window.teacherCoursesData = result.data; // Сохраняем данные

        courseSelect.innerHTML = '<option value="">-- Выберите курс --</option>';
        result.data.forEach(course => {
            const option = document.createElement('option');
            option.value = course.course_id;
            option.textContent = course.course_name;
            option.dataset.groups = JSON.stringify(course.groups);
            courseSelect.appendChild(option);
        });

    } catch (error) {
        console.error("Error loading teacher courses:", error);
        dataContainer.innerHTML = `<p style="color: red;">Не удалось загрузить курсы: ${error.message}</p>`;
    }
    
    courseSelect.addEventListener('change', () => updateGroupSelect(courseSelect, groupSelect, loadBtn));
    groupSelect.addEventListener('change', () => toggleLoadButton(groupSelect, loadBtn));
    
    loadBtn.addEventListener('click', loadAssessmentTables);
}

function updateGroupSelect(courseSelect, groupSelect, loadBtn) {
    groupSelect.innerHTML = '';
    groupSelect.disabled = true;
    loadBtn.disabled = true;

    const selectedOption = courseSelect.options[courseSelect.selectedIndex];
    if (selectedOption && selectedOption.value) {
        const groups = JSON.parse(selectedOption.dataset.groups || '[]');
        
        groupSelect.innerHTML = '<option value="">-- Выберите группу --</option>';
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group;
            option.textContent = group;
            groupSelect.appendChild(option);
        });
        
        groupSelect.disabled = groups.length === 0;
        if (groups.length === 0) {
             groupSelect.innerHTML = '<option value="">(Группы не найдены)</option>';
        }
    }
}

function toggleLoadButton(groupSelect, loadBtn) {
    loadBtn.disabled = !groupSelect.value;
}


async function loadAssessmentTables() {
    const courseId = document.getElementById('courseSelect').value;
    const groupName = document.getElementById('groupSelect').value;
    
    const dataContainer = document.getElementById('assessmentDataContainer');
    dataContainer.innerHTML = `<p class="loading-message">Загрузка данных для группы ${groupName}...</p>`;
    
    try {
        const response = await fetch(`/api/teacher/assessment_data/${courseId}/${encodeURIComponent(groupName)}`);
        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || "Ошибка при загрузке данных для выставления оценок.");
        }
        
        window.assessmentData = result.data;
        
        renderGradingInterface(dataContainer, result.data);

    } catch (error) {
        console.error("Error loading assessment data:", error);
        dataContainer.innerHTML = `<p style="color: red;">Не удалось загрузить данные: ${error.message}</p>`;
    }
}

async function showAssessmentTable(courseId, courseName, groupName) {
    document.getElementById('results-overview-container').style.display = 'none';
    
    const detailsSection = document.getElementById('course-details-section');
    detailsSection.style.display = 'block';
    
    document.getElementById('detailsTitle').textContent = `Выставление оценок: ${courseName} (${groupName})`;
    const container = document.getElementById('details-table-container');
    container.innerHTML = '<p class="loading-message">Загрузка шаблона оценок и списка студентов...</p>';

    try {
        const response = await fetch(`/api/teacher/assessment_table_data/${courseId}?group=${groupName}`);
        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || "Ошибка при получении данных с сервера.");
        }

        const { students, assessments } = result.data;

        if (assessments.length === 0) {
            container.innerHTML = `<div class="no-results-message">
                Шаблон оценок для этого курса не настроен. 
                <button onclick="createSchema(${courseId}, '${courseName}')" class="btn">Создать стандартный шаблон</button>
            </div>`;
            return;
        }

        let headerHtml = assessments.map(a => `<th data-assessment-id="${a.id}" class="assessment-header">
            ${a.assessment_name} 
            <span class="weight-info">(${a.weight}%)</span>
        </th>`).join('');

        let bodyHtml = students.map(student => {
            let rowHtml = assessments.map(a => {
                const currentScore = student.scores[a.id] !== undefined ? student.scores[a.id] : '';
                
                return `
                    <td>
                        <input type="number" 
                            class="grade-input" 
                            data-student-id="${student.id}" 
                            data-assessment-id="${a.id}" 
                            value="${currentScore}" 
                            min="0" max="${a.max_score}" 
                            placeholder="${a.max_score}">
                    </td>
                `;
            }).join('');

            return `
                <tr>
                    <td class="student-name" data-student-id="${student.id}">${student.full_name || student.username}</td>
                    ${rowHtml}
                </tr>
            `;
        }).join('');
        
        container.innerHTML = `
            <div class="save-controls">
                <button onclick="saveGrades(${courseId})" class="btn-save">Сохранить оценки</button>
                <span id="save-message" class="save-message"></span>
            </div>
            <table class="assessment-grading-table">
                <thead>
                    <tr>
                        <th class="student-name-header">Студент</th>
                        ${headerHtml}
                    </tr>
                </thead>
                <tbody>
                    ${bodyHtml}
                </tbody>
            </table>
        `;
        
    } catch (error) {
        console.error("Error loading assessment table:", error);
        container.innerHTML = `<div class="error-message">Не удалось загрузить данные для выставления оценок: ${error.message}</div>`;
    }
}

function renderGradingInterface(container, data) {
    if (data.students.length === 0) {
        container.innerHTML = `<p class="no-results-message">В группе "${document.getElementById('groupSelect').value}" нет студентов.</p>`;
        return;
    }
    
    const groupedAssessments = data.assessments.reduce((acc, item) => {
        if (!acc[item.category]) acc[item.category] = {};
        if (!acc[item.category][item.subcategory]) acc[item.category][item.subcategory] = [];
        acc[item.category][item.subcategory].push(item);
        return acc;
    }, {});
    
    let html = `
        <div class="grading-tabs">
            <button class="tab-button active" data-tab="weekly">Недельные оценки</button>
            <button class="tab-button" data-tab="srsp">СРСП</button>
            <button class="tab-button" data-tab="final">Итоговые оценки</button>
        </div>
        <form id="gradingForm">
            <div id="tab-weekly" class="tab-content active">
                ${renderWeeklyAssessments(groupedAssessments['Недельные'], data)}
            </div>
            <div id="tab-srsp" class="tab-content" style="display:none;">
                ${renderTeacherGradingTable(groupedAssessments['СРСП'] ? groupedAssessments['СРСП']['СРСП'] : [], data)}
            </div>
            <div id="tab-final" class="tab-content" style="display:none;">
                ${renderTeacherGradingTable(groupedAssessments['Итоговые'] ? Object.values(groupedAssessments['Итоговые']).flat() : [], data)}
            </div>
            
            <div style="margin-top: 25px; text-align: right;">
                <button type="submit" id="saveGradesBtn" class="action-btn" style="background-color: #2ecc71;">Сохранить оценки</button>
                <div id="saveMessage" style="margin-top: 10px;"></div>
            </div>
        </form>
    `;
    
    container.innerHTML = html;
    
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', (e) => {
            const tabId = e.target.dataset.tab;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            e.target.classList.add('active');
            document.getElementById(`tab-${tabId}`).style.display = 'block';
        });
    });
    
    document.getElementById('gradingForm').addEventListener('submit', saveGrades);
}

function renderWeeklyAssessments(weeklyData, data) {
    if (!weeklyData) return '<p>Нет данных по недельным оценкам.</p>';
    
    let html = '';
    
    if (weeklyData['Практика']) {
        html += '<h4>Практика (1-15 Неделя)</h4>';
        html += renderTeacherGradingTable(weeklyData['Практика'], data, 'weekly-practice');
    }
    
    if (weeklyData['Лекции']) {
        html += '<h4 style="margin-top: 20px;">Лекции (1-15 Неделя)</h4>';
        html += renderTeacherGradingTable(weeklyData['Лекции'], data, 'weekly-lectures');
    }
    
    return html;
}

function renderTeacherGradingTable(assessments, data, tableId = '') {
    if (assessments.length === 0) return '<p>Нет типов оценок для этой категории.</p>';
    
    let tableHtml = `<div class="table-scroll"><table class="grading-table" id="${tableId}"><thead><tr><th>Студент</th>`;
    
    assessments.forEach(ass => {
        tableHtml += `<th title="${ass.assessment_name}" data-assessment-id="${ass.id}">${ass.assessment_name.replace('Неделя ', 'Н').replace('Практика, ', '').replace('Лекция, ', '')}</th>`;
    });
    
    tableHtml += `</tr></thead><tbody>`;
    
    data.students.forEach(student => {
        tableHtml += `<tr><td>${student.full_name}</td>`;
        
        assessments.forEach(ass => {
            const assessmentId = ass.id;
            const currentScore = data.grades[student.student_id] 
                                && data.grades[student.student_id][assessmentId] 
                                ? data.grades[student.student_id][assessmentId] 
                                : '';
                                
            tableHtml += `<td><input 
                            type="number" 
                            min="0" 
                            max="100" 
                            value="${currentScore}"
                            data-student-id="${student.student_id}" 
                            data-assessment-id="${assessmentId}"
                            class="grade-input"
                            style="width: 50px; text-align: center;"></td>`;
        });
        
        tableHtml += `</tr>`;
    });
    
    tableHtml += `</tbody></table></div>`;
    
    return tableHtml;
}


async function saveGrades(e) {
    e.preventDefault();
    const saveBtn = document.getElementById('saveGradesBtn');
    const saveMessage = document.getElementById('saveMessage');
    
    saveBtn.disabled = true;
    saveMessage.textContent = 'Сохранение...';
    saveMessage.style.color = '#3498db';

    const courseId = document.getElementById('courseSelect').value;
    const gradesToSave = [];
    
    document.querySelectorAll('.grade-input').forEach(input => {
        const score = parseFloat(input.value);
        
        if (input.value !== '' && !isNaN(score) && score >= 0 && score <= 100) {
            gradesToSave.push({
                student_id: parseInt(input.dataset.studentId),
                assessment_type_id: parseInt(input.dataset.assessmentId),
                course_id: parseInt(courseId),
                score: score
            });
        }
    });

    try {
        const response = await fetch('/api/teacher/save_assessments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(gradesToSave)
        });
        
        const result = await response.json();

        if (response.ok && result.success) {
            saveMessage.textContent = `Успешно сохранено ${gradesToSave.length} оценок.`;
            saveMessage.style.color = '#27ae60';
        } else {
            throw new Error(result.error || 'Неизвестная ошибка при сохранении.');
        }

    } catch (error) {
        console.error("Save error:", error);
        saveMessage.textContent = `Ошибка сохранения: ${error.message}`;
        saveMessage.style.color = '#e74c3c';
    } finally {
        saveBtn.disabled = false;
    }
}



function activateTab(tabId) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

    const activeBtn = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
    const activePane = document.getElementById(`tab-${tabId}-content`);
    if (activePane) {
        activePane.classList.add('active');
    }
}

function calculateOverallSummary(assessments) {
    let totalEarnedWeight = 0; 
    let maxWeight = 0;         

    assessments.forEach(item => {
        const weight = parseFloat(item.weight) || 0;
        const maxScore = parseFloat(item.max_score) || 1; 

        if (weight > 0) {
            maxWeight += weight;
            
            if (item.score !== null) {
                const score = parseFloat(item.score) || 0;
                
                const earnedPoints = (score / maxScore) * weight;
                totalEarnedWeight += earnedPoints;
            }
        }
    });

    const finalPercent = totalEarnedWeight > 0 ? (totalEarnedWeight / maxWeight) * 100 : 0;

    const getLetterGrade = (percent) => {
        if (percent >= 90) return 'A';
        if (percent >= 80) return 'B';
        if (percent >= 70) return 'C';
        if (percent >= 60) return 'D';
        return 'F';
    };

    return {
        totalEarnedWeight: totalEarnedWeight.toFixed(2),
        maxWeight: maxWeight.toFixed(2),
        finalPercent: finalPercent.toFixed(2),
        letterGrade: getLetterGrade(finalPercent)
    };
}

function renderWeeklyTable(data) {
    if (Object.keys(data).length === 0) {
        return '<p class="no-results-message">Недельные оценки пока не проставлены.</p>';
    }

    let html = `
        <h3 class="assessment-category-title">Недельные Оценки (Вес: 1% каждая)</h3>
        <table class="assessment-table weekly-table">
            <thead>
                <tr>
                    <th>Неделя</th>
                    <th>Практика</th>
                    <th>Лекции</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    for (let i = 1; i <= 15; i++) {
        const weekData = data[i] || {};
        const p = weekData.practice;
        const l = weekData.lecture;

        const formatScore = (item) => {
            if (!item) return '—';
            return item.score !== null 
                ? `<span class="score-value">${item.score}</span> / ${item.max_score}`
                : `<span class="score-value not-set">—</span> / ${item.max_score}`;
        };

        html += `
            <tr>
                <td>Неделя ${i}</td>
                <td>${formatScore(p)}</td>
                <td>${formatScore(l)}</td>
            </tr>
        `;
    }

    html += `
            </tbody>
        </table>
    `;

    return html;
}

function renderStudentResultsTable(assessments, title) {
    if (assessments.length === 0) {
        return `<p class="no-results-message">Оценки по категории "${title}" пока не проставлены.</p>`;
    }

    let html = `
        <h3 class="assessment-category-title">${title}</h3>
        <table class="assessment-table">
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Вес (%)</th>
                    <th>Макс. Балл</th>
                    <th>Полученный Балл</th>
                </tr>
            </thead>
            <tbody>
    `;

    assessments.forEach(item => {
        const weightValue = parseFloat(item.weight) || 0;
        const maxScoreValue = parseFloat(item.max_score) || 100;

        const scoreDisplay = item.score !== null 
            ? `<span class="score-value">${parseFloat(item.score)}</span>` 
            : `<span class="score-value not-set">—</span>`;

        html += `
            <tr>
                <td>${item.assessment_name}</td>
                <td>${weightValue.toFixed(2)}%</td>  <td>${maxScoreValue}</td>
                <td>${scoreDisplay}</td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
    `;

    return html;
}

function renderSummaryTab(summary) {
    return `
        <h2 class="page-header">Общий Результат по Курсу</h2>
        <div class="summary-box">
            <p><strong>Общий Вес Курса:</strong> ${summary.maxWeight}%</p>
            <p><strong>Набранный Вес (Текущий):</strong> ${summary.totalEarnedWeight}%</p>
            <hr>
            <p class="final-grade-line">
                <strong>ИТОГОВЫЙ ПРОЦЕНТ:</strong> 
                <span class="final-percent-value">${summary.finalPercent}%</span>
            </p>
            <p class="final-grade-line">
                <strong>БУКВЕННАЯ ОЦЕНКА:</strong> 
                <span class="final-letter-value grade-${summary.letterGrade.toLowerCase()}">${summary.letterGrade}</span>
            </p>
        </div>
        <p class="summary-note">
            * Итоговый процент рассчитан на основе проставленных оценок и их весов.
        </p>
    `;
}

function renderHomePage(userData) {
    const container = document.getElementById('contentArea');
    
    const userName = userData.full_name || userData.username || 'Пользователь';
    const roleRu = {
        'student': 'Студент',
        'teacher': 'Преподаватель',
        'admin': 'Администратор'
    }[userData.role] || userData.role;

    container.innerHTML = `
        <h2 class="page-header" style="color: #34495e;">Добро пожаловать, ${userName}!</h2>
        <p style="margin-bottom: 30px; color: #7f8c8d;">Ваша роль: **${roleRu}**. Ознакомьтесь с последними новостями и календарем.</p>

        <div class="news-grid">
            
            <a href="#" class="news-card">
                <img src="/uploads/erasmus2026.png" alt="Новость 1" class="news-image">
                <div class="news-content">
                    <h3>Объявлен старт программы академической мобильности "Erasmus+" на 2026 год</h3>
                    <p>30 Ноября 2025</p>
                </div>
            </a>

            <a href="#" class="news-card">
                <img src="/uploads/zasedanie1.jpg" alt="Новость 2" class="news-image">
                <div class="news-content">
                    <h3>Заседание Ученого Совета: утверждение новых образовательных программ</h3>
                    <p>25 Ноября 2025</p>
                </div>
            </a>

            <a href="#" class="news-card">
                <img src="/uploads/AI-Hackathon-2.png" alt="Новость 3" class="news-image">
                <div class="news-content">
                    <h3>Студенческий хакатон по искусственному интеллекту собрал рекордное количество команд</h3>
                    <p>20 Ноября 2025</p>
                </div>
            </a>
            
        </div>
        <h2 class="page-header" style="color: #34495e; margin-top: 40px;">Академический Календарь</h2>
        <div id="calendar"></div>
    `;
    
    loadAcademicCalendar(); 
    
    setActiveMenu(document.getElementById('homeLink'));
}

function setActiveMenu(activeElement) {
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active-menu');
    });
    if (activeElement) {
        activeElement.classList.add('active-menu');
    }
}

async function loadAcademicCalendar() {
    const eventsRes = await fetch('/api/calendar/events');
    const result = await eventsRes.json();
    
    if (!result.success) {
        console.error("Failed to load academic events:", result.error);
        return;
    }
    
    const calendarEl = document.getElementById('calendar');
    
    const isAdmin = window.userData && window.userData.role === 'admin';
    
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth', 
        locale: 'ru',               
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: isAdmin ? 'dayGridMonth,dayGridWeek,dayGridDay addButton' : 'dayGridMonth,dayGridWeek,dayGridDay'
        },
        
        editable: isAdmin,
        selectable: isAdmin,
        
        events: result.data, 
        eventDisplay: 'block', 
        eventColor: '#8b0000', 

        
        eventDrop: async function(info) {

            if (!confirm(`Вы уверены, что хотите переместить событие "${info.event.title}"?`)) {
                info.revert();
                return;
            }

            const success = await saveCalendarEvent(info.event, 'update');
            if (!success) { info.revert(); }
        },

        eventResize: async function(info) {
             if (!confirm(`Вы уверены, что хотите изменить продолжительность события "${info.event.title}"?`)) {
                info.revert();
                return;
            }
            const success = await saveCalendarEvent(info.event, 'update');
            if (!success) { info.revert(); }
        },
        
        select: async function(info) {
            const title = prompt('Введите название нового события:');
            if (title) {
                const newEvent = {
                    title: title,
                    start: info.start,
                    end: info.end,
                    backgroundColor: '#2ecc71',
                    id: null,
                    extendedProps: { description: '' }
                };
                
                const newId = await saveCalendarEvent(newEvent, 'create');
                
                if (newId) {
                    newEvent.id = newId;
                    calendar.addEvent(newEvent);
                }
            }
            calendar.unselect();
        },
        

        eventClick: function(info) {
            if (!isAdmin) return;
            handleEventClick(info.event, calendar);
        }
    });


    calendar.render();
    

    updateNextEventWidget(result.data);
}

function updateNextEventWidget(events) {
    if (!events || events.length === 0) {
        document.getElementById('nextEventTitle').textContent = 'Нет запланированных событий';
        document.getElementById('nextEventDate').textContent = '';
        return;
    }
    
    const today = new Date().toISOString().slice(0, 10);
    
    const nextEvent = events.find(event => event.start >= today);

    if (nextEvent) {
        const startDate = new Date(nextEvent.start).toLocaleDateString('ru-RU', { 
            day: 'numeric', month: 'long', year: 'numeric' 
        });
        document.getElementById('nextEventTitle').textContent = nextEvent.title;
        document.getElementById('nextEventDate').textContent = `Дата: ${startDate}`;
    } else {
        document.getElementById('nextEventTitle').textContent = 'Все события в прошлом';
        document.getElementById('nextEventDate').textContent = '';
    }
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toastNotification');
    toast.textContent = message;
    
    toast.style.backgroundColor = '';
    
    if (type === 'success') {
        toast.style.backgroundColor = '#2ecc71';
    } else if (type === 'error') {
        toast.style.backgroundColor = '#e74c3c';
    } else if (type === 'info') {
        toast.style.backgroundColor = '#3498db';
    } else {
        toast.style.backgroundColor = '#333';
    }

    toast.style.opacity = 1;
    toast.style.visibility = 'visible';
    
    setTimeout(function(){ 
        toast.style.opacity = 0;
        toast.style.visibility = 'hidden';
    }, 3000);
}


async function saveCalendarEvent(eventData, type) {

    const dataToSend = {
        id: eventData.id || null,
        title: eventData.title,
        start: eventData.start.toISOString().slice(0, 10),
        end: eventData.end ? eventData.end.toISOString().slice(0, 10) : null,
        color: eventData.backgroundColor || '#8b0000',
        description: eventData.extendedProps.description || ''
    };
    
    showToast(`Сохранение события: ${dataToSend.title}...`, 'info'); 

    try {
        const response = await fetch('/api/admin/calendar/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSend)
        });
        const result = await response.json();

        if (result.success) {
            showToast(`Событие успешно ${dataToSend.id ? 'обновлено' : 'создано'}.`, 'success');
            
            if (type === 'create' && result.newId) {
                return result.newId;
            }
            return true;
        } else {
            showToast(`Ошибка сохранения: ${result.error}`, 'error');
            return false;
        }
    } catch (error) {
        showToast('Ошибка сети при сохранении события.', 'error');
        console.error("Calendar save error:", error);
        return false;
    }
}
    

function handleEventClick(event, calendar) {
    const action = prompt(`Событие: "${event.title}". Выберите действие:\n1. Редактировать (R)\n2. Удалить (D)\n3. Отмена (Cancel)`, 'R');
    
    if (action === null) return;

    if (action.toUpperCase() === 'R') {
        const newTitle = prompt('Новое название:', event.title);
        const newColor = prompt('Новый цвет (HEX, например, #3498db):', event.backgroundColor);
        
        if (newTitle !== null && newTitle !== event.title || newColor !== null && newColor !== event.backgroundColor) {
            event.setProp('title', newTitle);
            event.setProp('backgroundColor', newColor);
            
            saveCalendarEvent(event, 'update');
        }
        
    } else if (action.toUpperCase() === 'D') {

        if (confirm(`Вы уверены, что хотите удалить событие "${event.title}"?`)) {
            deleteCalendarEvent(event.id, calendar, event);
        }
    }
}


async function deleteCalendarEvent(eventId, calendar, event) {
    showToast(`Удаление события ID ${eventId}...`, 'info'); 
    
    try {
        const response = await fetch('/api/admin/calendar/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: eventId })
        });
        const result = await response.json();

        if (result.success) {
            event.remove();
            showToast('Событие успешно удалено.', 'success');
        } else {
            showToast(`Ошибка удаления: ${result.error}`, 'error');
        }
    } catch (error) {
        showToast('Ошибка сети при удалении события.', 'error');
        console.error("Calendar delete error:", error);
    }
}


    </script>
    <div id="toastNotification" style="
    visibility: hidden; 
    min-width: 250px; 
    background-color: #333; 
    color: #fff; 
    text-align: center; 
    border-radius: 2px; 
    padding: 16px; 
    position: fixed; 
    z-index: 9999; 
    left: 50%; 
    bottom: 30px; 
    transform: translateX(-50%); 
    font-size: 17px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: visibility 0.3s, opacity 0.3s;
    opacity: 0;
"></div>
</body>
</html>