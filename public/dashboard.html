<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ | –ü–æ—Ä—Ç–∞–ª</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f9; display: flex; }
        
        .sidebar {
            width: 250px;
            background-color: #8b0000;
            color: white;
            min-height: 100vh;
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            position: fixed;
        }
        .user-info {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .user-icon {
            font-size: 50px;
            margin-bottom: 5px;
            line-height: 1;
        }
        .user-info p {
            margin: 0;
            font-size: 14px;
        }
        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            color: white;
            display: block;
        }
        .menu-item:hover {
            background-color: #a52a2a;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            flex-grow: 1;
        }
        .main-content h1 {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="user-info">
            <div class="user-icon">üë§</div>
            <p id="menuUsername">username</p>
            <p id="menuRole">role</p>
        </div>
        
        <a href="#" class="menu-item" id="profileLink">Profile</a>
        <a href="#" class="menu-item" id="courseLink">Courses</a>
        <a href="#" class="menu-item" id="scheduleLink">Schedule</a>
        <a href="#" class="menu-item">Results</a>
        <a href="#" class="menu-item" id="logoutLink">Logout</a>
    </div>

    <div class="main-content">
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –ø–æ—Ä—Ç–∞–ª!</h1>
        <p>–í–∞—à –∫–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å.</p>
        <div id="contentArea"></div>
    </div>

    <script>

let userRole = '';

async function loadProfile() {
    try {
        const profileRes = await fetch("/profile");
        
        if (profileRes.status === 401) {
            // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª 401, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
            window.location.href = '/'; 
            return;
        }

        const userData = await profileRes.json();
        
        document.getElementById('menuUsername').textContent = userData.username;
        document.getElementById('menuRole').textContent = userData.role;
        userRole = userData.role;
        document.getElementById('contentArea').textContent = `–í–∞—à–∞ —Ä–æ–ª—å: ${userData.role}`;

    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", error);
        window.location.href = '/'; 
    }
}

 document.getElementById('logoutLink').addEventListener('click', async (e) => {
            e.preventDefault();
            
            await fetch('/logout', { method: 'POST' });
            
            window.location.href = '/'; 
        });

        loadProfile();
async function saveSchedule() {
    // –í—Å—è –ª–æ–≥–∏–∫–∞, –∫–æ—Ç–æ—Ä—É—é –º—ã –ø–∏—Å–∞–ª–∏, –æ—Å—Ç–∞—ë—Ç—Å—è –∑–¥–µ—Å—å. 
    // –û–Ω–∞ –±–µ—Ä–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ DOM, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ contentArea.
    const groupName = document.getElementById('groupSelector').value;
    const dayOfWeek = document.getElementById('daySelector').value;
    const msgBox = document.getElementById('scheduleMessage');
    const tableBody = document.getElementById('scheduleInputTable').querySelector('tbody');
    const rows = tableBody.querySelectorAll('tr');

    const lessons = [];

    rows.forEach(row => {
        const timeSlot = row.getAttribute('data-time');
        const course = row.querySelector('input[data-field="course"]').value.trim();
        const classroom = row.querySelector('input[data-field="classroom"]').value.trim();
        
        if (course || classroom) {
            lessons.push({ time_slot: timeSlot, 
                course: course || '', 
                classroom: classroom || '' });
        }
    });

    if (lessons.length === 0) {
        msgBox.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.';
        msgBox.style.color = 'red';
        return;
    }

    try {
        // ... (–ª–æ–≥–∏–∫–∞ fetch, –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        msgBox.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        msgBox.style.color = 'orange';

        const res = await fetch("/api/save_schedule", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ groupName, dayOfWeek, lessons })
        });

        const data = await res.json();
        
        if (data.success) {
            msgBox.textContent = `‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${groupName} (${dayOfWeek}) —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!`;
            msgBox.style.color = 'green';
        } else {
            msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
            msgBox.style.color = 'red';
        }

    } catch (error) {
        // ...
        console.error("Save schedule error:", error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.';
        msgBox.style.color = 'red';
    }
}

async function loadTeacherSchedule() {
    // –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const group = document.getElementById('groupSelector').value;
    const day = document.getElementById('daySelector').value;
    const msgBox = document.getElementById('scheduleMessage');
    
    // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π (—á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)
    const tableBody = document.getElementById('scheduleInputTable').querySelector('tbody');
    tableBody.querySelectorAll('input').forEach(input => input.value = '');

    if (!group || !day) {
        msgBox.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.';
        msgBox.style.color = 'blue';
        return;
    }
    
    msgBox.textContent = `‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è ${group} (${day})...`;
    msgBox.style.color = 'orange';

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GET-–∑–∞–ø—Ä–æ—Å —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º /api/get_schedule?group=X, –∫–∞–∫ –≤—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ –≤ server.js
        const res = await fetch(`/api/get_schedule?group=${group}&day=${day}`);
        const data = await res.json();
        
        if (data.success && data.schedule && data.schedule.length > 0) {
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ (schedule - —ç—Ç–æ –º–∞—Å—Å–∏–≤ —É—Ä–æ–∫–æ–≤)
            data.schedule.forEach(lesson => {
                const row = tableBody.querySelector(`tr[data-time="${lesson.time_slot}"]`);
                if (row) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–µ–¥–º–µ—Ç –∏ –∞—É–¥–∏—Ç–æ—Ä–∏—é
                    row.querySelector('input[data-field="course"]').value = lesson.course;
                    row.querySelector('input[data-field="classroom"]').value = lesson.classroom;
                    // –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∑–∞–ø–æ–ª–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ, —Ç.–∫. –µ–≥–æ ID –±–µ—Ä–µ—Ç—Å—è –∏–∑ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                }
            });
            
            msgBox.textContent = `‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${group} (${day}) –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.`;
            msgBox.style.color = 'green';
            
        } else {
            msgBox.textContent = `‚ö†Ô∏è –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è ${group} (${day}) –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ú–æ–∂–Ω–æ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ.`;
            msgBox.style.color = 'orange';
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —É—á–∏—Ç–µ–ª—è:', error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.';
        msgBox.style.color = 'red';
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∫—É—Ä—Å–æ–≤ –¥–ª—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
async function loadAdminCourses() {
    const tableBody = document.getElementById('coursesTableBody');
    const msgBox = document.getElementById('coursesMessage');
    const saveBtn = document.getElementById('saveCourseBtn');
    
    if (saveBtn) {
        saveBtn.removeEventListener('click', saveCourse); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π, –µ—Å–ª–∏ –µ—Å—Ç—å
        saveBtn.addEventListener('click', saveCourse);
    }
    document.getElementById('cancelEditBtn').addEventListener('click', resetCourseForm);

    if (tableBody) tableBody.innerHTML = '';
    if (msgBox) msgBox.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤...';

    try {
        // –ú—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–¢ –ñ–ï API, —á—Ç–æ –∏ –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è, –Ω–æ –ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ teacher_id
        const res = await fetch("/api/get_all_courses");
        const data = await res.json();
        
        if (!data.success || !data.courses || data.courses.length === 0) {
            if (msgBox) msgBox.textContent = '–ù–µ—Ç –∫—É—Ä—Å–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.';
            return;
        }

        if (msgBox) msgBox.textContent = '–í—Å–µ–≥–æ –∫—É—Ä—Å–æ–≤: ' + data.courses.length;
        
        data.courses.forEach(course => {
            const row = tableBody.insertRow();
            row.insertCell().textContent = course.id;
            row.insertCell().textContent = course.name;
            row.insertCell().textContent = course.group_name; 
            row.insertCell().textContent = course.semester;  
            row.insertCell().textContent = course.teacher_id;
            row.insertCell().textContent = course.credits;
            
            // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            const actionsCell = row.insertCell();
            
            const editBtn = document.createElement('button');
            editBtn.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å';
            editBtn.onclick = () => editCourse(course);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            deleteBtn.onclick = () => deleteCourse(course.id);
            
            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(deleteBtn);
        });

    } catch (error) {
        console.error("Error loading courses for Admin:", error);
        if (msgBox) msgBox.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏! –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã.';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ JS-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
function attachContentHandlers(role) {
       if (document.getElementById('groupSelector') || document.getElementById('scheduleTableBody')) {
        
        if (role === 'teacher') {
            const saveBtn = document.getElementById('saveScheduleBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveSchedule);
            }
            
            document.getElementById('groupSelector')?.addEventListener('change', loadTeacherSchedule);
            document.getElementById('daySelector')?.addEventListener('change', loadTeacherSchedule);
            
            loadTeacherSchedule(); 

        } else if (role === 'student') {
            loadStudentSchedule();
        }
    }

    if (document.getElementById('coursesTableBody')) {
         
        if (role === 'admin') {
            loadAdminCourses(); // <-–¥–ª—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        } else {
            loadCourses(); // <-–¥–ª—è –°—Ç—É–¥–µ–Ω—Ç–æ–≤/–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π

             if (role === 'student') {
                const selector = document.getElementById('semesterSelector');
                    if (selector) {
                    selector.removeEventListener('change', loadCourses);
                    selector.addEventListener('change', loadCourses); 
                }
                }
        }
    }
    if (document.querySelector('.profile-layout')) { 
        if (role === 'student' || role === 'teacher') { 
            // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            loadProfileData(); 
            // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –≤–∫–ª–∞–¥–∫–∞–º –ø—Ä–æ—Ñ–∏–ª—è
            attachProfileNavigation(); 
        }
        const form = document.getElementById('changePasswordForm');
        if (form) {
            form.removeEventListener('submit', changePassword); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
            form.addEventListener('submit', changePassword); 
        }

        const photoForm = document.getElementById('changePhotoForm');
        const fileInput = document.getElementById('avatarFile');

        if (photoForm && fileInput) {
            photoForm.removeEventListener('submit', uploadAvatar);
            photoForm.addEventListener('submit', uploadAvatar);
            
            fileInput.removeEventListener('change', updateFileNameDisplay);
            fileInput.addEventListener('change', updateFileNameDisplay);
        }
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã
function resetCourseForm() {
    document.getElementById('courseId').value = '';
    document.getElementById('courseName').value = '';
    document.getElementById('courseDescription').value = '';
    document.getElementById('courseCredits').value = '';
    document.getElementById('courseTeacherId').value = '';
      document.getElementById('courseGroup').value = '';
    document.getElementById('courseSemester').value = '';
    document.getElementById('saveCourseBtn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ö—É—Ä—Å';
    document.getElementById('formMessage').textContent = '';
    document.getElementById('cancelEditBtn').style.display = 'none';
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∫—É—Ä—Å–∞
function editCourse(course) {
    document.getElementById('courseId').value = course.id;
    document.getElementById('courseName').value = course.name;
    document.getElementById('courseDescription').value = course.description;
    document.getElementById('courseCredits').value = course.credits;
    document.getElementById('courseTeacherId').value = course.teacher_id;
    document.getElementById('courseGroup').value = course.group_name;
    document.getElementById('courseSemester').value = course.semester;
    
    document.getElementById('saveCourseBtn').textContent = '–û–±–Ω–æ–≤–∏—Ç—å –ö—É—Ä—Å';
    document.getElementById('cancelEditBtn').style.display = 'inline';
    document.getElementById('formMessage').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞: ' + course.name;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
async function saveCourse() {
    const courseId = document.getElementById('courseId').value || null;
    const name = document.getElementById('courseName').value.trim();
    const group_name = document.getElementById('courseGroup').value.trim(); 
    const semester = parseInt(document.getElementById('courseSemester').value.trim()); 

    const description = document.getElementById('courseDescription').value.trim();
    const credits = parseInt(document.getElementById('courseCredits').value.trim());
    const teacher_id = parseInt(document.getElementById('courseTeacherId').value.trim());
    const msgBox = document.getElementById('formMessage');

    if (!name || isNaN(credits) || isNaN(teacher_id) || !group_name || isNaN(semester)) {
        msgBox.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.';
        return;
    }

    try {
        msgBox.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        const res = await fetch("/api/save_course", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: courseId, name, description, credits, teacher_id, group_name, semester })
        });
        
        const data = await res.json();
        
        if (data.success) {
            msgBox.textContent = `‚úÖ –ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ ${courseId ? '–æ–±–Ω–æ–≤–ª–µ–Ω' : '–¥–æ–±–∞–≤–ª–µ–Ω'}!`;
            resetCourseForm();
            loadAdminCourses(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
        } else {
            msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
        }

    } catch (error) {
        console.error("Save course error:", error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.';
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞
async function deleteCourse(id) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫—É—Ä—Å?')) return;
    
    const msgBox = document.getElementById('coursesMessage');
    msgBox.textContent = '‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ...';

    try {
        const res = await fetch("/api/delete_course", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id })
        });
        
        const data = await res.json();
        
        if (data.success) {
            msgBox.textContent = `‚úÖ –ö—É—Ä—Å ID ${id} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`;
            loadAdminCourses(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
        } else {
            msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
        }

    } catch (error) {
        console.error("Delete course error:", error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.';
    }
}

async function loadContent(path) {
     let targetFile = '';
    
    // 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–∏ –∏ –ø—É—Ç–∏
    if (path === '/schedule') {
        targetFile = userRole === 'teacher' ? 'teacher_schedule.html' : 'student_schedule.html';
    } else if (path === '/profile') {
         // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏–ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
        targetFile = userRole === 'teacher' ? 'teacher_profile.html' : 'student_profile.html'; // –°–æ–∑–¥–∞–π—Ç–µ teacher_profile –ø–æ–∑–∂–µ
    }
    else if (path === '/courses') {
        if (userRole === 'admin') {
            targetFile = 'admin_courses.html';}
        else{
        targetFile = userRole === 'teacher' ? 'teacher_courses.html' : 'student_courses.html';}
    } 
    else {
        console.error('Unknown path:', path);
        document.getElementById('contentArea').innerHTML = '<p style="color: red;">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é.</p>';
        return;
    }

    // 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ fetch –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–º—É —Ñ–∞–π–ª—É
    try {
        const res = await fetch(targetFile); // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é
        if (!res.ok) throw new Error(`Failed to load ${targetFile} (${res.status})`);
        
        const html = await res.text();
        
        // 3. –í—Å—Ç–∞–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        document.getElementById('contentArea').innerHTML = html; 
        attachContentHandlers(userRole);
        
    } catch (error) {
        console.error('Error loading content:', error);
        document.getElementById('contentArea').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: ' + error.message + '</p>';
    }
}

async function loadProfileData() {
    const contentHeader = document.getElementById('contentHeader');
    const msgBox = document.getElementById('personal-data-section');
    
    if (contentHeader) contentHeader.textContent = '–õ–ò–ß–ù–´–ï –î–ê–ù–ù–´–ï (–ó–∞–≥—Ä—É–∑–∫–∞...)';

    try {
        const res = await fetch("/api/get_profile_data"); // –ù–û–í–´–ô API
        const data = await res.json();
        
        if (data.success && data.user) {
            const user = data.user;
            
            // 1. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            document.getElementById('profileUsername').textContent = user.username || 'N/A';
            
            // 2. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–µ–∫—Ü–∏–∏ "–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
            document.getElementById('displayUsername').textContent = user.username || '‚Äî';
            document.getElementById('displayName').textContent = user.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –ø–æ–ª–µ full_name
            document.getElementById('displayId').textContent = user.id || '‚Äî';
            document.getElementById('displayGroup').textContent = user.group_name || '‚Äî';
            
            // –≠—Ç–∏ –ø–æ–ª—è –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ë–î, –Ω–æ –ø–æ–∫–∞ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–≥–ª—É—à–∫–∏
            document.getElementById('displayMajor').textContent = user.major || '–ù–µ –∑–∞–¥–∞–Ω–æ'; 
            document.getElementById('displayEntranceYear').textContent = user.entrance_year || '–ù–µ –∑–∞–¥–∞–Ω';

            if (contentHeader) contentHeader.textContent = '–õ–ò–ß–ù–´–ï –î–ê–ù–ù–´–ï';
        } else {
            if (msgBox) msgBox.innerHTML = '<p style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
            if (contentHeader) contentHeader.textContent = '–û–®–ò–ë–ö–ê';
        }
    } catch (error) {
        console.error("Profile load error:", error);
        if (msgBox) msgBox.innerHTML = '<p style="color:red;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è.</p>';
        if (contentHeader) contentHeader.textContent = '–û–®–ò–ë–ö–ê –°–ï–¢–ò';
    }
}

document.getElementById('scheduleLink').addEventListener('click', (e) => {
    e.preventDefault();
    loadContent('/schedule');
});

document.getElementById('courseLink').addEventListener('click', (e) => {
    e.preventDefault();
    loadContent('/courses');
});

document.getElementById('profileLink').addEventListener('click', (e) => {
    e.preventDefault();
    loadContent('/profile');
});
async function loadStudentSchedule() {
            const msgBox = document.getElementById('scheduleMessage');
            const tableBody = document.getElementById('scheduleTableBody');
            
            tableBody.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É

            console.log("--- 1. —Ñ—É–Ω–∫—Ü–∏—è loadstudentSchedule –∑–∞–ø—É—â–µ–Ω–∞ ---");

            try {

                console.log("--- 2. –û—Ç–ø—Ä–∞–≤–∫–∞ fetch –∑–∞–ø—Ä–æ—Å–∞... ---");
                // –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –°–µ—Ä–≤–µ—Ä —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≥—Ä—É–ø–ø—É —Å—Ç—É–¥–µ–Ω—Ç–∞.
                const res = await fetch("/api/get_schedule");

                console.log("--- 3. Fetch –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç! ---");
                const data = await res.json();

                console.log("Schedule response:", data);
                
                if (data.success && data.schedule && data.schedule.length > 0) {
                    msgBox.textContent = `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã: ${data.group}`;
                    msgBox.style.color = 'green';
                    document.getElementById('scheduleTitle').textContent = `–í–∞—à–µ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (${data.group})`;
                    
                    let currentDay = '';
                    
                    data.schedule.forEach(lesson => {
                        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
                        if (lesson.day_of_week !== currentDay) {
                            currentDay = lesson.day_of_week;
                            const dayRow = document.createElement('tr');
                            dayRow.innerHTML = `<td colspan="4" class="day-header">${currentDay}</td>`;
                            tableBody.appendChild(dayRow);
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —É—Ä–æ–∫–∞
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${lesson.time_slot}</td>
                            <td style="text-align: left;">${lesson.course}</td>
                            <td>${lesson.classroom}</td>
                            <td>${lesson.teacher_name}</td>
                        `;
                        tableBody.appendChild(row);
                    });

                } else {
                    msgBox.textContent = data.error || `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã ${data.group || '–í–∞—à–µ–π –≥—Ä—É–ø–ø—ã'} –ø–æ–∫–∞ –Ω–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–æ.`;
                    msgBox.style.color = 'red';
                }

            } catch (error) {
                console.error("Schedule load error:", error);
                msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.';
                msgBox.style.color = 'red';
            }
        };

async function loadCourses() {
    const tableBody = document.getElementById('coursesTableBody');
    const msgBox = document.getElementById('coursesMessage');
    
    const role = userRole;

    // –û—á–∏—â–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    if (tableBody) tableBody.innerHTML = ''; 
    if (msgBox) msgBox.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';

    try {
        let apiUrl = "/api/get_courses"

        if(role === 'student') {
            const semesterSelector = document.getElementById('semesterSelector');
            const selectedSemester = semesterSelector ? semesterSelector.value : '1'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1
            
            apiUrl = `/api/get_courses?semester=${selectedSemester}`; 
        }
        const res = await fetch(apiUrl);
        const data = await res.json();
        
        if (!data.success || !data.courses || data.courses.length === 0) {
            if (msgBox) msgBox.textContent = '–°–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω.';
            return;
        }
        

        if (msgBox) msgBox.textContent = ''; //–û—á–∏—Å—Ç–∫–∞

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—É—Ä—Å–æ–≤ –¥–ª—è –°–¢–£–î–ï–ù–¢–ê
       if (data.role === 'student') {
                const tableBody = document.getElementById('coursesTableBody');
                if (tableBody) tableBody.innerHTML = '';
                
                data.courses.forEach(course => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = course.course_name;
                    row.insertCell().textContent = course.teacher_name; 
                    row.insertCell().textContent = course.credits;
                    row.insertCell().textContent = course.description || '‚Äî';
                });
        } else if (data.role === 'teacher') {
            data.courses.forEach(course => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = course.course_name;
                row.insertCell().textContent = course.credits;
                row.insertCell().textContent = course.groups_taught || '–ù–µ—Ç –≥—Ä—É–ø–ø';
            });
        }

    } catch (error) {
        console.error("Error loading courses:", error);
        if (msgBox) msgBox.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏! –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã.';
    }
}

function attachProfileNavigation() {
    const navButtons = document.querySelectorAll('.profile-nav-btn');
    const sections = document.querySelectorAll('.profile-section');
    const contentHeader = document.getElementById('contentHeader');

    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetSectionId = button.getAttribute('data-section');
            const targetHeader = button.textContent;

            // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π
            sections.forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(targetSectionId + '-section').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            if (contentHeader) contentHeader.textContent = targetHeader.toUpperCase();
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è "–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
            if (targetSectionId === 'personal-data') {
                loadProfileData(); 
            }
        });
    });
}

async function changePassword(e) {
    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

    const currentPass = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmNewPassword').value;
    const msgBox = document.getElementById('passwordMessage');
    
    msgBox.textContent = ''; 

    if (newPass.length < 6) {
        msgBox.textContent = '‚ùå –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤.';
        msgBox.style.color = 'red';
        return;
    }
    
    if (newPass !== confirmPass) {
        msgBox.textContent = '‚ùå –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –∏ –µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.';
        msgBox.style.color = 'red';
        return;
    }

    if (currentPass === newPass) {
        msgBox.textContent = '‚ùå –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–∫—É—â–∏–º.';
        msgBox.style.color = 'red';
        return;
    }

    msgBox.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';
    msgBox.style.color = 'orange';

    try {
        const res = await fetch("/api/change_password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                currentPassword: currentPass, 
                newPassword: newPass 
            })
        });

        const data = await res.json();

        if (data.success) {
            msgBox.textContent = '‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!';
            msgBox.style.color = 'green';
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
            document.getElementById('changePasswordForm').reset();
        } else {
            msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.');
            msgBox.style.color = 'red';
        }
    } catch (error) {
        console.error("Change password error:", error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è.';
        msgBox.style.color = 'red';
    }
}
    
// dashboard.html (–≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–∞ <script>)
function updateFileNameDisplay() {
    const fileInput = document.getElementById('avatarFile');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    
    if (fileInput.files.length > 0) {
        fileNameDisplay.textContent = fileInput.files[0].name;
    } else {
        fileNameDisplay.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
    }
}    
    

async function uploadAvatar(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('avatarFile');
    const msgBox = document.getElementById('photoMessage');
    
    if (fileInput.files.length === 0) {
        msgBox.textContent = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.';
        msgBox.style.color = 'red';
        return;
    }

    const file = fileInput.files[0];
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –±–æ–ª–µ–µ 5 –ú–ë)
    if (file.size > 5 * 1024 * 1024) {
        msgBox.textContent = '‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5 –ú–ë).';
        msgBox.style.color = 'red';
        return;
    }
    
    msgBox.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...';
    msgBox.style.color = 'orange';

    // FormData –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–≤–æ–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ñ–∞–π–ª–æ–≤)
    const formData = new FormData();
    formData.append('avatar', file);

    try {
        const res = await fetch("/api/upload_avatar", {
            method: "POST",
            // –í–∞–∂–Ω–æ: 'Content-Type' –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è! fetch —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å boundary –¥–ª—è FormData.
            body: formData 
        });

        const data = await res.json();
        
        if (res.status === 200 && data.success) {
            msgBox.textContent = '‚úÖ –ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!';
            msgBox.style.color = 'green';
            
            // ‚ùó –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ç–æ
            const currentAvatar = document.getElementById('currentAvatar');
            // –î–æ–±–∞–≤–ª—è–µ–º –∫ –ø—É—Ç–∏ –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞
            currentAvatar.src = data.filePath + '?t=' + new Date().getTime();
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('changePhotoForm').reset();
            document.getElementById('fileNameDisplay').textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';

        } else {
            msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.');
            msgBox.style.color = 'red';
        }
    } catch (error) {
        console.error("Upload error:", error);
        msgBox.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞.';
        msgBox.style.color = 'red';
    }
}
    
    
    
    </script>
</body>
</html>